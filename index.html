<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Leads Angra</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) CDN -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- html2canvas CDN for image generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://css.gg/css?=|check|close|user|upload|search|tag|phone|mail|list|calendar|hash|briefcase|bookmark|link" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Estilos globais para a fonte e transições */
        body { font-family: 'Inter', sans-serif; }
        .transition-all { transition: all 0.3s ease-in-out; }
        /* Animação para resultados da importação */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        /* Estilo para botões de toggle de documento */
        .doc-toggle {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            min-width: 50px;
            text-align: center;
        }
        .doc-toggle.doc-sim {
            background-color: #10B981; /* green-500 */
            color: white;
            border-color: #059669; /* green-600 */
        }
        .doc-toggle.doc-nao {
            background-color: #FEE2E2; /* red-100 */
            color: #B91C1C; /* red-700 */
            border-color: #FCA5A5; /* red-300 */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Container Principal do App -->
    <div id="app-container" class="hidden">
        
        <!-- Cabeçalho e Navegação -->
        <header class="bg-blue-800 text-white shadow-lg sticky top-0 z-10">
            <div class="max-w-7xl mx-auto p-4 flex flex-col md:flex-row justify-between items-center">
                <h1 class="text-2xl font-bold tracking-tight mb-2 md:mb-0 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-2 h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="18" x2="12" y2="22"/></svg>
                    Gestão de Leads Angra
                </h1>
                <nav id="main-nav" class="flex space-x-2 sm:space-x-4">
                    <!-- Nav items will be dynamically injected here based on user role -->
                </nav>
                <div class="flex items-center space-x-4 mt-2 md:mt-0">
                    <div id="user-info-display" class="text-sm p-2 bg-blue-700 rounded-lg text-blue-200 shadow-inner hidden lg:block">
                        <!-- O nome e perfil do usuário serão injetados aqui -->
                    </div>
                    <button id="btn-logout" class="p-2 bg-red-500 hover:bg-red-600 text-white rounded-lg shadow-md transition-all text-sm flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        Sair
                    </button>
                </div>
            </div>
        </header>

        <!-- Conteúdo Principal -->
        <main class="flex-grow p-4 md:p-8">
            <div class="max-w-7xl mx-auto">
                <div id="view-dashboard" class="view-content space-y-8 hidden"></div>
                <div id="view-cadastro" class="view-content space-y-8 hidden"></div>
                <div id="view-historico" class="view-content space-y-8 hidden"></div>
                <div id="view-bases" class="view-content space-y-8 hidden"></div>
                <div id="view-controle-bases" class="view-content space-y-8 hidden"></div>
                <div id="view-campanhas" class="view-content space-y-8 hidden"></div>
                <div id="view-gap" class="view-content space-y-8 hidden"></div>
                <div id="view-admin" class="view-content space-y-8 hidden"></div>
            </div>
        </main>

        <!-- Rodapé -->
        <footer class="bg-gray-900 text-white p-4 mt-8">
            <div id="footer-content" class="max-w-7xl mx-auto text-center text-sm text-gray-400">
                Sistema de Gestão de Leads Angra
            </div>
        </footer>
    </div>
    
    <!-- Tela de Carregamento Inicial -->
    <div id="loading-screen" class="flex justify-center items-center h-screen bg-gray-100 p-4">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 mx-auto text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-600 font-semibold">Conectando ao sistema...</p>
        </div>
    </div>
    
    <!-- Tela de Autenticação (Login/Cadastro) -->
    <div id="auth-screen" class="hidden flex justify-center items-center h-screen bg-gray-100 p-4">
        <div id="auth-card" class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl border border-gray-200">
            <!-- Conteúdo da autenticação será injetado aqui -->
        </div>
    </div>

    <!-- Toast Notification para substituir os alertas -->
    <div id="toast-notification" class="fixed top-5 right-5 bg-blue-600 text-white py-3 px-5 rounded-lg shadow-lg z-50 transform transition-transform duration-500 ease-in-out translate-x-[120%]">
        <p id="toast-message"></p>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirm-modal-overlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 flex justify-center items-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-lg font-bold text-gray-800">Confirmar Ação</h3>
            <p id="confirm-modal-message" class="my-4 text-gray-600"></p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-modal-cancel" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Firebase e JS Logic -->
    <script type="module">
        // Importações do Firebase via CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            addDoc, 
            updateDoc, 
            onSnapshot, 
            serverTimestamp, 
            doc, 
            getDocs,
            getDoc,
            setDoc,
            writeBatch,
            where,
            deleteDoc,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variáveis de Configuração e Globais ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gestaodeleadsangra-2cc1d';
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config !== "{}"
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "AIzaSyDucVe9OerO1nDpvMaMhWquyxkcco1GTZA",
                authDomain: "gestaodeleadsangra-2cc1d.firebaseapp.com",
                projectId: "gestaodeleadsangra-2cc1d",
                storageBucket: "gestaodeleadsangra-2cc1d.appspot.com",
                messagingSenderId: "914587846773",
                appId: "1:914587846773:web:fdd7dc3cc4fcf93529903c"
            };
        
        const LEADS_COLLECTION_PATH = `artifacts/${appId}/public/data/leads`;
        const USERS_COLLECTION_PATH = `artifacts/${appId}/public/data/users`;
        const GAP_COLLECTION_PATH = `artifacts/${appId}/public/data/gap_academico`;
        const PLANNER_COLLECTION_PATH = `artifacts/${appId}/public/data/planner`;
        const BASES_COLLECTION_PATH = `artifacts/${appId}/public/data/bases`;
        const BOM_DIA_CAPTACAO_COLLECTION_PATH = `artifacts/${appId}/public/data/bomDiaCaptacao`;
        const FORECAST_CAPTACAO_COLLECTION_PATH = `artifacts/${appId}/public/data/forecastCaptacao`;
        const CONTROLE_BASES_COLLECTION_PATH = `artifacts/${appId}/public/data/controleBases`;
        const CAPTACAO_CONFIG_PATH = `artifacts/${appId}/public/data/configuracaoCaptacao`;
        const PERIODO_CONFIG_DOC_ID = "periodo_atual";
        const CAMPANHAS_COLLECTION_PATH = `artifacts/${appId}/public/data/campanhas`;
        const LINKS_UTEIS_COLLECTION_PATH = `artifacts/${appId}/public/data/linksUteis`;


        let db;
        let auth;
        let currentUser = null;
        let leadsData = [];
        let usersData = [];
        let gapData = [];
        let plannerData = [];
        let basesData = [];
        let bomDiaCaptacaoData = [];
        let forecastData = [];
        let controleBasesData = [];
        let captacaoConfigData = null;
        let campanhasData = [];
        let linksUteisData = [];
        let currentView = 'cadastro';
        let isAuthReady = false;
        let unsubscribeLeads = () => {};
        let unsubscribeUsers = () => {};
        let unsubscribeGap = () => {};
        let unsubscribePlanner = () => {};
        let unsubscribeBases = () => {};
        let unsubscribeBomDiaCaptacao = () => {};
        let unsubscribeForecastCaptacao = () => {};
        let unsubscribeControleBases = () => {};
        let unsubscribeCaptacaoConfig = () => {};
        let unsubscribeCampanhas = () => {};
        let unsubscribeLinksUteis = () => {};
        
        let leadFilterState = { acao: '', dia: '', promotorId: '', status: 'all', telefone: '', curso: '' };
        let gapFilterState = { nome: '', cpf: '', matAcad: 'all', gap: 'all', produto: '', curso: '', semestre: '', metodologia: '', formaIngresso: '' };
        let baseFilterState = { nome: '', cpf: '', produto: '', curso: '', nomeBase: '', status: 'all' };
        let controleBasesFilterState = { period: 'this_month', atendenteId: 'all', meioDisparo: 'all' };
        let campanhaFilterState = { nome: '', data: '', status: 'all' };

        // --- Configuração de Perfis e Permissões ---
        const ROLES = { 
            PROMOTOR: 'Promotor', 
            FDV: 'FDV',
            SALA_MATRICULA: 'Sala de Matrícula',
            QG: 'QG', 
            LIDER_FDV: 'Líder/FDV' 
        };

        const VIEW_PERMISSIONS = { 
            'dashboard': [ROLES.PROMOTOR, ROLES.FDV, ROLES.SALA_MATRICULA, ROLES.QG, ROLES.LIDER_FDV],
            'cadastro':  [ROLES.PROMOTOR, ROLES.FDV, ROLES.SALA_MATRICULA, ROLES.QG, ROLES.LIDER_FDV], 
            'historico': [ROLES.FDV, ROLES.SALA_MATRICULA, ROLES.QG, ROLES.LIDER_FDV], 
            'bases':     [ROLES.SALA_MATRICULA, ROLES.QG, ROLES.LIDER_FDV],
            'controle-bases': [ROLES.SALA_MATRICULA, ROLES.QG, ROLES.LIDER_FDV],
            'campanhas': [ROLES.SALA_MATRICULA, ROLES.QG, ROLES.LIDER_FDV],
            'gap':       [ROLES.SALA_MATRICULA, ROLES.LIDER_FDV],
            'admin':     [ROLES.LIDER_FDV] 
        };

        // --- Helpers de UI e Formatação ---
        const formatCpf = (cpf) => cpf ? String(cpf).replace(/\D/g, '') : '';
        const formatPhone = (phone) => phone ? String(phone).replace(/\D/g, '') : '';
        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        };
        const formatDateForInput = (date) => {
             if (!date) return '';
             const d = date.toDate ? date.toDate() : new Date(date);
             // Ajusta para o fuso horário local para evitar problemas de "um dia antes"
             d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
             return d.toISOString().split('T')[0];
        };

        function calculateWeekdays(startDate, endDate) {
            let count = 0;
            const currentDate = new Date(startDate.getTime());
            while (currentDate <= endDate) {
                const dayOfWeek = currentDate.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) { // 0 = Sunday, 6 = Saturday
                    count++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return count;
        }

        const generateIcon = (svgPath) => `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${svgPath}</svg>`;
        const ICONS = {
            USERS: generateIcon('<path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/>'),
            CHECK: generateIcon('<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>'),
            PERCENT: generateIcon('<line x1="19" y1="5" x2="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/>'),
            USER: generateIcon('<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>'),
            UPLOAD: generateIcon('<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>'),
            DOWNLOAD: generateIcon('<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>'),
            TAG: generateIcon('<path d="M20.59 13.41l-7.15 7.15a2.12 2.12 0 0 1-3-.01L3 13.25V4a1 1 0 0 1 1-1h9.25l7.34 7.34a2.12 2.12 0 0 1 0 3z"/><line x1="10" y1="10" x2="10.01" y2="10"/>'),
            PHONE: generateIcon('<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.08 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>'),
            MAIL: generateIcon('<path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>'),
            LIST: generateIcon('<line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>'),
            CALENDAR: generateIcon('<rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>'),
            HASH: generateIcon('<line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="15" x2="20" y2="15"/><line x1="10" y1="3" x2="8" y2="21"/><line x1="16" y1="3" x2="14" y2="21"/>'),
            ACADEMIC: generateIcon('<path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3.33 1.67 6.67 1.67 10 0v-5"/>'),
            DATABASE: generateIcon('<ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>'),
            BOOKMARK: generateIcon('<path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>'),
            CLOSE: generateIcon('<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>'),
            BRIEFCASE: generateIcon('<rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>'),
            LINK: generateIcon('<path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>'),
        };
        
        // --- UI Helpers ---
        const toast = document.getElementById('toast-notification');
        const toastMessage = document.getElementById('toast-message');
        let toastTimeout;
        let confirmCallback = null;
        const confirmModal = document.getElementById('confirm-modal-overlay');
        const confirmMsg = document.getElementById('confirm-modal-message');

        function showToast(message, isError = false) {
            clearTimeout(toastTimeout);
            toastMessage.textContent = message;
            toast.classList.remove('bg-blue-600', 'bg-red-600');
            toast.classList.add(isError ? 'bg-red-600' : 'bg-blue-600');
            toast.classList.remove('translate-x-[120%]');
            toastTimeout = setTimeout(() => {
                toast.classList.add('translate-x-[120%]');
            }, 4000);
        }

        function showConfirm(message, callback) {
            confirmMsg.textContent = message;
            confirmCallback = callback;
            confirmModal.classList.remove('hidden');
        }

        document.getElementById('confirm-modal-cancel').addEventListener('click', () => {
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        });

        document.getElementById('confirm-modal-confirm').addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        });

        // --- Funções de Navegação e Renderização de UI ---
        function canView(viewName) {
            if (!currentUser || !VIEW_PERMISSIONS[viewName]) {
                return false;
            }
            return VIEW_PERMISSIONS[viewName].includes(currentUser.role);
        }

        function renderView(viewName) {
             if (!canView(viewName)) {
                 if(canView('dashboard')) viewName = 'dashboard';
                 else if (canView('cadastro')) viewName = 'cadastro';
                 else {
                     document.getElementById('app-container').innerHTML = '<p class="text-center p-8">Você não tem permissão para visualizar nenhuma página.</p>';
                     return;
                 }
             }
            document.querySelectorAll('.view-content').forEach(view => view.classList.add('hidden'));
            const targetView = document.getElementById(`view-${viewName}`);
            if (targetView) targetView.classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-blue-600', 'text-white');
                item.classList.add('text-blue-200', 'hover:bg-blue-700');
                if (item.dataset.view === viewName) {
                    item.classList.add('bg-blue-600', 'text-white');
                }
            });
            currentView = viewName;
            switch(viewName) {
                case 'dashboard': renderDashboard(); break;
                case 'cadastro': renderRegistration(); break;
                case 'historico': renderHistory(); break;
                case 'bases': renderBasesView(); break;
                case 'controle-bases': renderControleBasesView(); break;
                case 'campanhas': renderCampanhasView(); break;
                case 'gap': renderGapView(); break;
                case 'admin': renderAdminPanel(); break;
            }
        }

        function renderNav() {
            const nav = document.getElementById('main-nav');
            let navHTML = '';
            const navConfig = [
                { view: 'dashboard', label: 'Painel', icon: ICONS.CHECK },
                { view: 'cadastro', label: 'Leads', icon: ICONS.USER },
                { view: 'historico', label: 'Histórico', icon: ICONS.LIST },
                { view: 'bases', label: 'Bases', icon: ICONS.DATABASE },
                { view: 'controle-bases', label: 'Controle', icon: ICONS.BOOKMARK },
                { view: 'campanhas', label: 'Campanhas', icon: ICONS.BRIEFCASE },
                { view: 'gap', label: 'GAP', icon: ICONS.ACADEMIC },
                { view: 'admin', label: 'Gerenciar', icon: ICONS.USERS }
            ];

            navConfig.forEach(item => {
                if (canView(item.view)) {
                    navHTML += `<button class="nav-item flex items-center space-x-2 p-2 rounded-lg transition-all text-sm" data-view="${item.view}">
                        ${item.icon.replace('h-5 w-5 mr-2 inline-block', 'h-5 w-5')}
                        <span class="hidden sm:inline">${item.label}</span>
                    </button>`;
                }
            });
            nav.innerHTML = navHTML;
            
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.addEventListener('click', (e) => renderView(e.currentTarget.dataset.view));
            });
        }
        
        // --- 1. Inicialização do Firebase e Autenticação ---
        async function initApp() {
            try {
                if (!firebaseConfig || !firebaseConfig.apiKey || !firebaseConfig.projectId) {
                    throw new Error("A configuração do Firebase (firebaseConfig) está ausente ou incompleta. A aplicação não pode ser iniciada.");
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                let customTokenAttempted = false;

                onAuthStateChanged(auth, async (user) => {
                    if (user && !user.isAnonymous) {
                        await handleUserLogin(user);
                    } else {
                        if (customTokenAttempted || (typeof __initial_auth_token === 'undefined' || !__initial_auth_token)) {
                            document.getElementById('loading-screen').classList.add('hidden');
                            handleUserLogout();
                        }
                    }
                });
                
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    customTokenAttempted = true;
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (authError) {
                        console.error("Erro ao autenticar com token customizado:", authError);
                        // O observer onAuthStateChanged vai lidar com o estado de não-logado.
                    }
                } else {
                    customTokenAttempted = true; // Se não há token, o estado inicial já pode ser decidido.
                }

                document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

            } catch (error) {
                console.error("ERRO CRÍTICO NA INICIALIZAÇÃO:", error);
                document.getElementById('loading-screen').innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-lg text-center"><strong>Erro Fatal</strong><br>${error.message}</div>`;
            }
        }
        
        async function handleUserLogin(user) {
            const userProfile = await fetchUserProfile(user.uid, user.email);
            currentUser = { uid: user.uid, email: user.email, ...userProfile };
            isAuthReady = true;
            
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            document.getElementById('user-info-display').innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="gg-user"></i>
                    <span class="font-semibold">${currentUser.name || currentUser.email}</span>
                    <span class="text-xs bg-blue-500 px-2 py-0.5 rounded-full">${currentUser.role}</span>
                </div>
            `;
            document.getElementById('footer-content').innerText = "Sistema de Gestão de Leads | Criado por Marcos Teixeira";
            
            renderNav();
            setupDataListeners();

            let initialView = 'cadastro';
            if (canView('dashboard')) {
                initialView = 'dashboard';
            }
            renderView(initialView);
        }

        function handleUserLogout() {
            currentUser = null;
            isAuthReady = false;
            leadsData = [];
            usersData = [];
            gapData = [];
            plannerData = [];
            bomDiaCaptacaoData = [];
            forecastData = [];
            controleBasesData = [];
            campanhasData = [];
            linksUteisData = [];
            unsubscribeLeads();
            unsubscribeUsers();
            unsubscribeGap();
            unsubscribePlanner();
            unsubscribeBases();
            unsubscribeBomDiaCaptacao();
            unsubscribeForecastCaptacao();
            unsubscribeControleBases();
            unsubscribeCaptacaoConfig();
            unsubscribeCampanhas();
            unsubscribeLinksUteis();
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('auth-screen').classList.remove('hidden');
            renderAuthScreen(true);
        }

        async function fetchUserProfile(uid, email, name = null) {
            const userDocRef = doc(db, USERS_COLLECTION_PATH, uid);
            const userDocSnap = await getDoc(userDocRef);

            if (userDocSnap.exists()) {
                return userDocSnap.data();
            } else {
                let isFirstUser = false;
                try {
                    const usersQuery = query(collection(db, USERS_COLLECTION_PATH));
                    const allUsersSnapshot = await getDocs(usersQuery);
                    isFirstUser = allUsersSnapshot.empty;
                } catch (error) {
                    console.warn("Could not query users collection to determine role.", error);
                    isFirstUser = true; 
                }

                const newRole = isFirstUser ? ROLES.LIDER_FDV : ROLES.PROMOTOR;
                const defaultName = email ? email.split('@')[0] : `user_${uid.substring(0, 6)}`;

                const newProfile = {
                    email: email,
                    role: newRole,
                    name: name || defaultName,
                    createdAt: serverTimestamp(),
                };
                await setDoc(userDocRef, newProfile);
                return newProfile;
            }
        }
        
        function renderAuthScreen(isLogin) {
            const authCard = document.getElementById('auth-card');
            authCard.innerHTML = `
                <h2 class="text-3xl font-extrabold text-gray-900 text-center mb-6">${isLogin ? 'Acesso ao Sistema' : 'Crie sua Conta'}</h2>
                <div id="auth-message" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg"></div>
                <form id="auth-form" class="space-y-4">
                    ${!isLogin ? renderInputField("Nome Completo", "auth-name", "text", true, "Seu nome e sobrenome", ICONS.USER) : ''}
                    ${renderInputField("Email", "auth-email", "email", true, "seu@email.com", ICONS.MAIL)}
                    ${renderInputField("Senha", "auth-password", "password", true, "Mínimo 6 caracteres", ICONS.HASH)}
                    <button type="submit" id="btn-auth-submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl">${isLogin ? 'Entrar' : 'Cadastrar'}</button>
                </form>
                <p class="mt-6 text-center text-sm text-gray-600">
                    ${isLogin ? "Não tem uma conta?" : "Já tem uma conta?"}
                    <button id="btn-toggle-auth" class="font-semibold text-blue-600 hover:text-blue-800">${isLogin ? "Crie uma conta" : "Faça Login"}</button>
                </p>`;
            document.getElementById('btn-toggle-auth').addEventListener('click', () => renderAuthScreen(!isLogin));
            document.getElementById('auth-form').addEventListener('submit', (e) => handleAuth(e, isLogin));
        }

        async function handleAuth(e, isLogin) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const name = !isLogin ? document.getElementById('auth-name').value : null;
            const msgEl = document.getElementById('auth-message');
            msgEl.classList.add('hidden');

            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    if (!name) {
                        msgEl.textContent = 'O campo "Nome Completo" é obrigatório.';
                        msgEl.classList.remove('hidden');
                        return;
                    }
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await fetchUserProfile(userCredential.user.uid, email, name);
                }
            } catch (error) {
                console.error("Authentication Error:", error);
                let msg = 'Ocorreu um erro.';
                if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                    msg = 'Email ou senha incorretos.';
                } else if (error.code === 'auth/email-already-in-use') {
                    msg = 'Este email já está cadastrado. Por favor, faça login.';
                } else if (error.code === 'auth/weak-password') {
                    msg = 'A senha deve ter pelo menos 6 caracteres.';
                } else if (error.code === 'auth/invalid-email') {
                    msg = 'O formato do email é inválido.';
                }
                msgEl.textContent = msg;
                msgEl.classList.remove('hidden');
            }
        }
        
        // --- 2. Listeners de Dados ---
        function setupDataListeners() {
            if (!db || !currentUser || !isAuthReady) {
                console.warn("A configuração dos listeners de dados foi abortada: a autenticação não está pronta.");
                retur
