// Bibliotecas do React e Firebase
import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged,
  createUserWithEmailAndPassword, // Adicionado para Cadastro
  signInWithEmailAndPassword,     // Adicionado para Login
  signOut                         // Adicionado para Sair
} from 'firebase/auth';
import { getFirestore, doc, collection, query, where, getDocs, addDoc, updateDoc, onSnapshot, serverTimestamp, setLogLevel } from 'firebase/firestore';

// Configuração do Tailwind CSS (assumido) e ícones (lucide-react)
import { Users, CheckCircle, Percent, PlusCircle, List, BarChart, XCircle, Search, Save, MessageSquare, User, Calendar, Tag, Smartphone, Mail, Globe, Hash, LogIn, UserPlus } from 'lucide-react';

// Variáveis globais do ambiente (Canvas)
// Configuração do Firebase fornecida pelo usuário como fallback, caso as variáveis de ambiente não estejam definidas.
const USER_FALLBACK_FIREBASE_CONFIG = {
    apiKey: "AIzaSyAY-rGNBHMsT5QqHHvNsZ9VzB3kyHtYPks",
    authDomain: "gestaodeleadsangra.firebaseapp.com",
    projectId: "gestaodeleadsangra",
    storageBucket: "gestaodeleadsangra.firebasestorage.app",
    messagingSenderId: "706992622509",
    appId: "1:706992622509:web:b091d4e27920d7d85e2f24"
};

// Prioriza as variáveis injetadas pelo ambiente (Canvas)
const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config.length > 2 
    ? JSON.parse(__firebase_config) 
    : USER_FALLBACK_FIREBASE_CONFIG;
    
const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId; // Usando projectId como fallback
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Caminho da coleção (pública para que todos os promotores vejam todos os leads)
const COLLECTION_PATH = `artifacts/${appId}/public/data/leads`;

// Helper para formatação do CPF (apenas números)
const formatCpf = (cpf) => cpf ? cpf.replace(/\D/g, '') : '';
// Helper para formatação do Telefone (apenas números)
const formatPhone = (phone) => phone ? phone.replace(/\D/g, '') : '';

// --- Componente Principal da Aplicação ---
const App = () => {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [fullUserId, setFullUserId] = useState(null); // ID completo para exibição
  const [isLoading, setIsLoading] = useState(true);
  const [leads, setLeads] = useState([]);
  const [currentView, setCurrentView] = useState('dashboard'); // 'dashboard', 'cadastro', 'historico'
  const [isAuthenticated, setIsAuthenticated] = useState(false); // Novo estado de autenticação

  // 1. Inicialização do Firebase e Autenticação
  useEffect(() => {
    try {
      // Ativa o log de debug do Firestore
      setLogLevel('debug');
      const app = initializeApp(firebaseConfig);
      const firestore = getFirestore(app);
      const firebaseAuth = getAuth(app);

      setDb(firestore);
      setAuth(firebaseAuth);

      const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
        if (user) {
          // Usuário autenticado (via login ou token inicial)
          setUserId(user.uid);
          setFullUserId(user.uid);
          setIsAuthenticated(true);
        } else {
          // Se não houver usuário logado, tenta o login silencioso via token inicial (ambiente Canvas)
          if (initialAuthToken) {
              try {
                  const userCredential = await signInWithCustomToken(firebaseAuth, initialAuthToken);
                  setUserId(userCredential.user.uid);
                  setFullUserId(userCredential.user.uid);
                  setIsAuthenticated(true);
              } catch(error) {
                  // Se o token falhar, ou não existir, exige login/cadastro
                  console.warn("Falha no login com token inicial ou token ausente. Exigindo login/cadastro.");
                  setIsAuthenticated(false);
              }
          } else {
              // Não há usuário e nem token inicial. Exige login/cadastro.
              setIsAuthenticated(false);
          }
        }
        setIsLoading(false);
      });

      return () => unsubscribe();
    } catch (error) {
      console.error("Erro na inicialização do Firebase:", error);
      setIsLoading(false);
    }
  }, []);

  // 2. Listener de Leads em Tempo Real (onSnapshot)
  useEffect(() => {
    if (db && userId) {
      const leadsCollectionRef = collection(db, COLLECTION_PATH);
      const q = query(leadsCollectionRef);

      // onSnapshot: mantém a lista de leads atualizada em tempo real
      const unsubscribe = onSnapshot(q, (snapshot) => {
        const leadsData = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        setLeads(leadsData);
      }, (error) => {
        console.error("Erro ao ouvir leads:", error);
      });

      return () => unsubscribe();
    }
  }, [db, userId]);

  // Função para mudar a visualização
  const changeView = (view) => setCurrentView(view);
  
  // Função para lidar com o logout
  const handleSignOut = useCallback(async () => {
    if (auth) {
      try {
        await signOut(auth);
        setUserId(null);
        setFullUserId(null);
        setIsAuthenticated(false);
        setCurrentView('dashboard'); // Volta para a dashboard (que vai mostrar a tela de login)
      } catch (error) {
        console.error("Erro ao fazer logout:", error);
      }
    }
  }, [auth]);

  // Se estiver carregando, mostra o indicador
  if (isLoading) {
    return (
      <div className="flex justify-center items-center h-screen bg-gray-50">
        <div className="text-xl font-medium text-blue-600">Carregando Sistema de Gestão de Leads...</div>
      </div>
    );
  }

  // Se não estiver autenticado, mostra a tela de Login/Cadastro
  if (!isAuthenticated && !isLoading) {
    return <AuthScreen auth={auth} />;
  }

  // --- Estrutura da UI Principal (Autenticado) ---
  return (
    <div className="min-h-screen bg-gray-50 flex flex-col font-sans">
      <Header 
        changeView={changeView} 
        currentView={currentView} 
        fullUserId={fullUserId} 
        onSignOut={handleSignOut} 
      />
      <main className="flex-grow p-4 md:p-8">
        <div className="max-w-7xl mx-auto">
          {currentView === 'dashboard' && <Dashboard leads={leads} userId={userId} />}
          {currentView === 'cadastro' && <LeadRegistration db={db} userId={userId} fullUserId={fullUserId} leads={leads} />}
          {currentView === 'historico' && <LeadHistory db={db} leads={leads} />}
        </div>
      </main>
      <Footer />
    </div>
  );
};

// --- Componente de Autenticação (Login/Cadastro) ---
const AuthScreen = ({ auth }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [isLogin, setIsLogin] = useState(true); // true = Login, false = Cadastro
  const [errorMessage, setErrorMessage] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);

  const handleAuth = async (e) => {
    e.preventDefault();
    setErrorMessage('');
    setIsProcessing(true);

    if (!email || !password) {
        setErrorMessage('Email e senha são obrigatórios.');
        setIsProcessing(false);
        return;
    }

    try {
      if (isLogin) {
        await signInWithEmailAndPassword(auth, email, password);
      } else {
        await createUserWithEmailAndPassword(auth, email, password);
      }
      // O App component detectará a mudança de estado e renderizará o dashboard
    } catch (error) {
      console.error("Erro de autenticação:", error);
      let msg = 'Ocorreu um erro na autenticação. Verifique suas credenciais.';
      
      // Mapeamento de erros comuns do Firebase Auth (em Português)
      if (error.code === 'auth/invalid-email') {
        msg = 'O formato do email é inválido.';
      } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
        msg = 'Email ou senha incorretos.';
      } else if (error.code === 'auth/email-already-in-use') {
        msg = 'Este email já está cadastrado. Por favor, faça login.';
      } else if (error.code === 'auth/weak-password') {
        msg = 'A senha deve ter pelo menos 6 caracteres.';
      }
      
      setErrorMessage(msg);
    } finally {
      setIsProcessing(false);
    }
  };

  const AuthInput = ({ label, type, value, onChange }) => (
    <div>
        <label className="block text-sm font-medium text-gray-700">{label}</label>
        <input
            type={type}
            value={value}
            onChange={onChange}
            required
            className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
        />
    </div>
  );

  return (
    <div className="flex justify-center items-center h-screen bg-gray-100 p-4">
      <div className="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl border border-gray-200">
        <h2 className="text-3xl font-extrabold text-gray-900 text-center mb-6 border-b pb-2 flex items-center justify-center space-x-2">
          {isLogin ? <LogIn className="h-7 w-7 text-blue-600" /> : <UserPlus className="h-7 w-7 text-blue-600" />}
          <span>{isLogin ? 'Acesso ao Sistema' : 'Cadastre-se'}</span>
        </h2>
        
        {errorMessage && (
          <div className="mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-center font-medium border border-red-300">
            {errorMessage}
          </div>
        )}

        <form onSubmit={handleAuth} className="space-y-4">
          <AuthInput
            label="Email"
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
          />
          <AuthInput
            label="Senha"
            type="password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
          />

          <button
            type="submit"
            disabled={isProcessing}
            className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-200 transform hover:scale-[1.01] flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {isProcessing ? (
                <>
                    <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>{isLogin ? 'Entrando...' : 'Cadastrando...'}</span>
                </>
            ) : (
                <span>{isLogin ? 'Entrar' : 'Cadastrar'}</span>
            )}
          </button>
        </form>

        <p className="mt-6 text-center text-sm text-gray-600">
          {isLogin ? "Não tem uma conta?" : "Já tem uma conta?"}
          <button
            onClick={() => {
                setIsLogin(!isLogin);
                setErrorMessage('');
                setEmail('');
                setPassword('');
            }}
            className="ml-2 font-semibold text-blue-600 hover:text-blue-800 transition duration-150"
          >
            {isLogin ? "Criar conta" : "Fazer Login"}
          </button>
        </p>
      </div>
    </div>
  );
};

// --- Componente de Cabeçalho (Header) ---
const Header = ({ changeView, currentView, fullUserId, onSignOut }) => (
  <header className="bg-blue-800 text-white shadow-lg sticky top-0 z-10">
    <div className="max-w-7xl mx-auto p-4 flex flex-col md:flex-row justify-between items-center">
      <h1 className="text-2xl font-bold tracking-tight mb-2 md:mb-0">
        <Globe className="inline-block mr-2 h-6 w-6" />
        Gestão de Leads Angra
      </h1>
      <nav className="flex space-x-2 sm:space-x-4">
        <NavItem 
          icon={BarChart} 
          label="Painel Principal" 
          view="dashboard" 
          currentView={currentView} 
          onClick={() => changeView('dashboard')} 
        />
        <NavItem 
          icon={PlusCircle} 
          label="Cadastrar Lead" 
          view="cadastro" 
          currentView={currentView} 
          onClick={() => changeView('cadastro')} 
        />
        <NavItem 
          icon={List} 
          label="Histórico / Acesso" 
          view="historico" 
          currentView={currentView} 
          onClick={() => changeView('historico')} 
        />
      </nav>
      <div className="flex items-center space-x-4 mt-2 md:mt-0">
        {fullUserId && (
          <div className="text-sm p-2 bg-blue-700 rounded-lg text-blue-200 shadow-inner hidden lg:block">
            <User className="inline-block h-4 w-4 mr-1" />
            Promotor ID: <span className="font-mono text-xs">{fullUserId}</span>
          </div>
        )}
        <button 
          onClick={onSignOut}
          className="p-2 bg-red-500 hover:bg-red-600 text-white rounded-lg shadow-md transition duration-200 text-sm flex items-center"
        >
          <XCircle className="h-4 w-4 mr-1" />
          Sair
        </button>
      </div>
    </div>
  </header>
);

// Item de navegação
const NavItem = ({ icon: Icon, label, view, currentView, onClick }) => {
  const isActive = view === currentView;
  const classes = isActive 
    ? "bg-blue-600 text-white shadow-md font-semibold" 
    : "text-blue-200 hover:bg-blue-700 hover:text-white";
  
  return (
    <button
      onClick={onClick}
      className={`flex items-center space-x-1 p-2 rounded-lg transition duration-200 text-sm ${classes}`}
    >
      <Icon className="h-4 w-4" />
      <span className="hidden sm:inline">{label}</span>
    </button>
  );
};


// --- Componente do Painel Principal (Dashboard) ---
const Dashboard = ({ leads, userId }) => {
  // Cálculos de estatísticas (useMemo para otimização)
  const stats = useMemo(() => {
    const totalLeads = leads.length;
    const convertedLeads = leads.filter(lead => lead.converted).length;
    const userLeads = leads.filter(lead => lead.promotorId === userId).length;
    const conversionRate = totalLeads > 0 
      ? ((convertedLeads / totalLeads) * 100).toFixed(1) 
      : 0.0;

    return { totalLeads, convertedLeads, userLeads, conversionRate };
  }, [leads, userId]);

  return (
    <div className="space-y-8">
      <h2 className="text-3xl font-extrabold text-gray-900 border-b-4 border-blue-500 pb-2 mb-4">Painel Principal - Visão Geral</h2>
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <StatCard 
          title="Total de Leads Cadastrados" 
          value={stats.totalLeads} 
          icon={Users} 
          color="bg-blue-500" 
        />
        <StatCard 
          title="Leads Convertidos" 
          value={stats.convertedLeads} 
          icon={CheckCircle} 
          color="bg-green-500" 
        />
        <StatCard 
          title="Taxa de Conversão Geral" 
          value={`${stats.conversionRate}%`} 
          icon={Percent} 
          color="bg-purple-500" 
        />
        <StatCard 
          title="Seus Leads Cadastrados" 
          value={stats.userLeads} 
          icon={User} 
          color="bg-yellow-500" 
        />
      </div>
      
      <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
        <h3 className="text-xl font-semibold text-gray-800 mb-4 flex items-center">
          <BarChart className="h-5 w-5 mr-2 text-blue-500" />
          Visão Rápida
        </h3>
        <p className="text-gray-600">
          O Painel Principal oferece uma visão em tempo real do volume de leads e do desempenho de conversão da equipe. 
          Use a aba **Cadastrar Lead** para adicionar novos contatos e a **Histórico / Acesso** para gerenciar e filtrar os resultados.
        </p>
      </div>
    </div>
  );
};

// Cartão de Estatística
const StatCard = ({ title, value, icon: Icon, color }) => (
  <div className={`p-5 rounded-xl shadow-xl border-l-4 ${color.replace('bg-', 'border-')} bg-white transition duration-300 hover:shadow-2xl`}>
    <div className="flex items-center justify-between">
      <div>
        <p className="text-sm font-medium text-gray-500 truncate">{title}</p>
        <p className="mt-1 text-3xl font-bold text-gray-900">{value}</p>
      </div>
      <div className={`p-3 rounded-full ${color} bg-opacity-10`}>
        <Icon className={`h-6 w-6 text-opacity-80`} style={{ color: color.replace('bg-', 'text-') }} />
      </div>
    </div>
  </div>
);

// --- Componente de Cadastro de Lead ---
const LeadRegistration = ({ db, userId, fullUserId, leads }) => {
  const [formData, setFormData] = useState({
    acao: '', nome: '', telefone: '', email: '', cpf: '', cursoInteresse: ''
  });
  const [message, setMessage] = useState(null);
  const [isError, setIsError] = useState(false);
  const [isSaving, setIsSaving] = useState(false);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
    if (message) setMessage(null); // Limpa a mensagem ao começar a digitar
  };

  const handleSave = async (e) => {
    e.preventDefault();
    setIsSaving(true);
    setMessage(null);
    setIsError(false);

    // 1. Validação dos Campos Obrigatórios
    if (!formData.acao || !formData.nome || !formData.telefone) {
      setMessage('Por favor, preencha os campos obrigatórios (Ação, Nome, Telefone).');
      setIsError(true);
      setIsSaving(false);
      return;
    }

    const cleanedPhone = formatPhone(formData.telefone);
    const cleanedCpf = formatCpf(formData.cpf);

    // 2. Verificação de Duplicidade (Telefone e CPF)
    // O CPF é opcional, só verifica se foi preenchido.
    const duplicateExists = leads.some(lead => {
      const existingPhone = formatPhone(lead.telefone);
      const existingCpf = formatCpf(lead.cpf);
      
      const isPhoneDuplicate = cleanedPhone && existingPhone === cleanedPhone;
      const isCpfDuplicate = cleanedCpf && cleanedCpf.length > 0 && existingCpf === cleanedCpf; // Só verifica CPF se houver CPF
      
      return isPhoneDuplicate || isCpfDuplicate;
    });

    if (duplicateExists) {
      setMessage('ERRO: Lead já cadastrado! Telefone ou CPF já existem no sistema. Não é permitido salvar dados duplicados.');
      setIsError(true);
      setIsSaving(false);
      return;
    }

    // 3. Salvamento no Firestore
    try {
      const newLead = {
        acao: formData.acao,
        nome: formData.nome,
        telefone: cleanedPhone, // Salva o telefone apenas com números
        email: formData.email,
        cpf: cleanedCpf, // Salva o CPF apenas com números
        cursoInteresse: formData.cursoInteresse,
        converted: false,
        createdAt: serverTimestamp(),
        promotorId: userId, // ID do usuário logado (para estatísticas)
        promotorUserId: fullUserId, // ID completo para exibição no histórico
      };

      const leadsCollectionRef = collection(db, COLLECTION_PATH);
      await addDoc(leadsCollectionRef, newLead);

      setMessage('Lead cadastrado com sucesso!');
      setIsError(false);
      // Limpar formulário, exceto 'acao' para agilizar cadastros repetidos
      setFormData(prev => ({
        ...prev, 
        nome: '', telefone: '', email: '', cpf: '', cursoInteresse: ''
      }));

    } catch (error) {
      console.error("Erro ao salvar o lead:", error);
      setMessage('Erro ao salvar o lead no banco de dados. Tente novamente.');
      setIsError(true);
    } finally {
      setIsSaving(false);
    }
  };

  const MessageDisplay = ({ message, isError }) => (
    <div className={`mt-4 p-3 rounded-lg text-center font-medium shadow-md ${isError ? 'bg-red-100 text-red-700 border border-red-300' : 'bg-green-100 text-green-700 border border-green-300'}`}>
      {message}
    </div>
  );

  return (
    <div className="space-y-8">
      <h2 className="text-3xl font-extrabold text-gray-900 border-b-4 border-blue-500 pb-2 mb-4">Cadastro de Novo Lead</h2>
      <div className="bg-white p-6 md:p-8 rounded-xl shadow-2xl max-w-2xl mx-auto border border-gray-100">
        
        {message && <MessageDisplay message={message} isError={isError} />}

        <form onSubmit={handleSave} className="space-y-4">
          <InputField 
            label="Nome da Ação" 
            name="acao" 
            value={formData.acao} 
            onChange={handleChange} 
            required 
            icon={Tag}
            placeholder="Ex: Evento Junino, Feira de Cursos"
          />
          <InputField 
            label="Nome Completo" 
            name="nome" 
            value={formData.nome} 
            onChange={handleChange} 
            required 
            icon={User}
          />
          <InputField 
            label="Telefone (WhatsApp)" 
            name="telefone" 
            value={formData.telefone} 
            onChange={handleChange} 
            type="tel"
            required 
            placeholder="Apenas números, inclua DDD (Ex: 24988887777)"
            icon={Smartphone}
          />
          <InputField 
            label="Email" 
            name="email" 
            value={formData.email} 
            onChange={handleChange} 
            type="email"
            icon={Mail}
            placeholder="exemplo@dominio.com"
          />
          <InputField 
            label="CPF" 
            name="cpf" 
            value={formData.cpf} 
            onChange={handleChange} 
            placeholder="Apenas números (Opcional, mas não pode ser duplicado)"
            icon={Hash}
          />
          <InputField 
            label="Curso de Interesse" 
            name="cursoInteresse" 
            value={formData.cursoInteresse} 
            onChange={handleChange} 
            icon={List}
            placeholder="Ex: Engenharia Civil, Administração"
          />
          
          <button 
            type="submit" 
            disabled={isSaving}
            className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-200 transform hover:scale-[1.01] flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {isSaving ? (
              <>
                <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Salvando...</span>
              </>
            ) : (
              <>
                <Save className="h-5 w-5" />
                <span>Salvar Novo Lead</span>
              </>
            )}
          </button>
        </form>
      </div>
    </div>
  );
};

// Input de Formulário reutilizável
const InputField = ({ label, name, value, onChange, required, icon: Icon, ...props }) => (
  <div>
    <label htmlFor={name} className="block text-sm font-medium text-gray-700 flex items-center">
      <Icon className="h-4 w-4 mr-1 text-blue-500" />
      {label}
      {required && <span className="ml-1 text-red-500">*</span>}
    </label>
    <div className="mt-1">
      <input
        type="text"
        name={name}
        id={name}
        value={value}
        onChange={onChange}
        required={required}
        className="block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150"
        {...props}
      />
    </div>
  </div>
);

// --- Componente de Histórico e Acesso de Leads ---
const LeadHistory = ({ db, leads }) => {
  const [filters, setFilters] = useState({
    acao: '',
    dia: '',
    promotorId: '',
    converted: 'all' // 'all', 'true', 'false'
  });

  const [uniqueActions, setUniqueActions] = useState([]);
  const [uniquePromotors, setUniquePromotors] = useState([]);

  // Popula os filtros de Ações e Promotores com base nos leads existentes
  useEffect(() => {
    const actions = [...new Set(leads.map(lead => lead.acao).filter(Boolean))];
    const promotors = [...new Set(leads.map(lead => lead.promotorUserId).filter(Boolean))];
    setUniqueActions(actions.sort());
    setUniquePromotors(promotors.sort());
  }, [leads]);


  const handleFilterChange = (e) => {
    const { name, value } = e.target;
    setFilters(prev => ({ ...prev, [name]: value }));
  };

  // Função de Ação: Marcar/Desmarcar Conversão
  const handleConversionToggle = useCallback(async (leadId, currentStatus) => {
    if (!db) return;
    try {
      const docRef = doc(db, COLLECTION_PATH, leadId);
      await updateDoc(docRef, {
        converted: !currentStatus
      });
    } catch (error) {
      console.error("Erro ao atualizar status de conversão:", error);
      // Usando console.error em vez de alert()
      console.log('Erro ao atualizar o status de conversão. Verifique a conexão.');
    }
  }, [db]);


  // Lógica de Filtragem
  const filteredLeads = useMemo(() => {
    let filtered = leads;

    // 1. Filtrar por Ação
    if (filters.acao) {
      filtered = filtered.filter(lead => lead.acao === filters.acao);
    }

    // 2. Filtrar por Dia
    if (filters.dia) {
      const filterDate = new Date(filters.dia).toDateString();
      filtered = filtered.filter(lead => {
        if (!lead.createdAt) return false;
        // Converte o Timestamp do Firestore para Date para comparação
        const leadDate = lead.createdAt.toDate ? lead.createdAt.toDate().toDateString() : new Date(lead.createdAt).toDateString();
        return leadDate === filterDate;
      });
    }

    // 3. Filtrar por Promotor
    if (filters.promotorId) {
      filtered = filtered.filter(lead => lead.promotorUserId === filters.promotorId);
    }

    // 4. Filtrar por Conversão
    if (filters.converted !== 'all') {
      const isConverted = filters.converted === 'true';
      filtered = filtered.filter(lead => lead.converted === isConverted);
    }

    // Ordena pelo mais recente (do Firestore Timestamp)
    filtered.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

    return filtered;
  }, [leads, filters]);


  const FilterSelect = ({ label, name, options, value, icon: Icon }) => (
    <div>
      <label htmlFor={name} className="block text-sm font-medium text-gray-700 mb-1 flex items-center">
        <Icon className="h-4 w-4 mr-1 text-blue-500" />
        {label}
      </label>
      <select
        id={name}
        name={name}
        value={value}
        onChange={handleFilterChange}
        className="block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white"
      >
        <option value="">-- Todos --</option>
        {options.map(opt => (
          <option key={opt} value={opt}>{opt}</option>
        ))}
      </select>
    </div>
  );

  return (
    <div className="space-y-8">
      <h2 className="text-3xl font-extrabold text-gray-900 border-b-4 border-blue-500 pb-2 mb-4">Acesso e Histórico de Leads</h2>

      {/* Área de Filtros */}
      <div className="bg-white p-6 rounded-xl shadow-lg grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 border border-gray-100">
        <FilterSelect 
          label="Ação" 
          name="acao" 
          options={uniqueActions} 
          value={filters.acao}
          icon={Tag}
        />
        <div>
          <label htmlFor="dia" className="block text-sm font-medium text-gray-700 mb-1 flex items-center">
            <Calendar className="h-4 w-4 mr-1 text-blue-500" />
            Dia de Cadastro
          </label>
          <input
            type="date"
            name="dia"
            id="dia"
            value={filters.dia}
            onChange={handleFilterChange}
            className="block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white"
          />
        </div>
        <FilterSelect 
          label="Promotor (ID)" 
          name="promotorId" 
          options={uniquePromotors} 
          value={filters.promotorId}
          icon={User}
        />
        <div className='col-span-1'>
          <label htmlFor="converted" className="block text-sm font-medium text-gray-700 mb-1 flex items-center">
            <CheckCircle className="h-4 w-4 mr-1 text-blue-500" />
            Status Conversão
          </label>
          <select
            id="converted"
            name="converted"
            value={filters.converted}
            onChange={handleFilterChange}
            className="block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white"
          >
            <option value="all">Todos os Status</option>
            <option value="true">Convertido</option>
            <option value="false">Pendente</option>
          </select>
        </div>
        <div className='flex items-end'>
          <button 
            onClick={() => setFilters({ acao: '', dia: '', promotorId: '', converted: 'all' })}
            className="w-full bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition duration-200 shadow-md flex items-center justify-center space-x-2"
          >
            <XCircle className="h-5 w-5" />
            <span>Limpar Filtros</span>
          </button>
        </div>
      </div>
      
      {/* Tabela de Leads */}
      <div className="overflow-x-auto bg-white rounded-xl shadow-2xl border border-gray-100">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-blue-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ação / Data</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome / Contato</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Curso / CPF</th>
              <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Conversão</th>
              <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {filteredLeads.length === 0 ? (
              <tr>
                <td colSpan="5" className="px-6 py-4 text-sm text-gray-500 text-center">Nenhum lead encontrado com os filtros aplicados.</td>
              </tr>
            ) : (
              filteredLeads.map(lead => (
                <LeadRow 
                  key={lead.id} 
                  lead={lead} 
                  onConversionToggle={handleConversionToggle} 
                />
              ))
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
};

// Linha da Tabela de Leads
const LeadRow = ({ lead, onConversionToggle }) => {
  // Cria o link do WhatsApp com o código do país (55 - Brasil)
  const waLink = `https://wa.me/55${lead.telefone}`;

  // Função para formatar data de criação
  const formatDate = (timestamp) => {
    if (!timestamp) return 'N/A';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleDateString('pt-BR');
  };

  return (
    <tr className="hover:bg-blue-50 transition duration-150">
      <td className="px-6 py-4 whitespace-nowrap">
        <div className="text-sm font-medium text-gray-900">{lead.acao}</div>
        <div className="text-xs text-gray-500 mt-1">
          <Calendar className="h-3 w-3 inline mr-1" />
          {formatDate(lead.createdAt)}
        </div>
      </td>
      <td className="px-6 py-4 whitespace-nowrap">
        <div className="text-sm font-semibold text-blue-600">{lead.nome}</div>
        <div className="text-xs text-gray-500">
            <Smartphone className="h-3 w-3 inline mr-1" />
            {lead.telefone}
        </div>
        <div className="text-xs text-gray-500 truncate max-w-[150px]">
            <Mail className="h-3 w-3 inline mr-1" />
            {lead.email || 'N/A'}
        </div>
      </td>
      <td className="px-6 py-4 whitespace-nowrap hidden sm:table-cell">
        <div className="text-sm text-gray-800">{lead.cursoInteresse || 'N/A'}</div>
        <div className="text-xs text-gray-500">Promotor: {lead.promotorUserId.substring(0, 8)}...</div>
      </td>
      <td className="px-6 py-4 whitespace-nowrap text-center">
        <button
          onClick={() => onConversionToggle(lead.id, lead.converted)}
          className={`px-3 py-1 rounded-full text-xs font-bold shadow-md transition duration-200 transform hover:scale-105 ${
            lead.converted ? 'bg-green-500 text-white hover:bg-green-600' : 'bg-red-100 text-red-700 hover:bg-red-200'
          }`}
          title="Clique para mudar o status de conversão"
        >
          {lead.converted ? 'CONVERTIDO' : 'PENDENTE'}
        </button>
      </td>
      <td className="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
        <a 
          href={waLink} 
          target="_blank" 
          rel="noopener noreferrer"
          className="inline-flex items-center justify-center p-3 bg-green-100 border-2 border-green-500 text-green-600 hover:text-white hover:bg-green-600 rounded-xl transition duration-200 shadow-md"
          title="Chamar no WhatsApp"
        >
          <MessageSquare className="h-5 w-5" />
        </a>
      </td>
    </tr>
  );
};

// --- Componente de Rodapé (Footer) ---
const Footer = () => (
  <footer className="bg-gray-900 text-white p-4 mt-8">
    <div className="max-w-7xl mx-auto text-center text-sm text-gray-400">
      Sistema de Gestão de Leads Angra | ID do Aplicativo: {appId}
    </div>
  </footer>
);

export default App;
