<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Leads Angra</title>
    <!-- Tailwind CSS CDN para estilos responsivos e modernos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://css.gg/css?=|check|close|user|upload|search|tag|phone|mail|list|calendar|hash" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Estilos globais para a fonte e transições */
        body { font-family: 'Inter', sans-serif; }
        .transition-all { transition: all 0.3s ease-in-out; }
        /* Animação para resultados do CSV */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Container Principal do App -->
    <div id="app-container" class="hidden">
        
        <!-- Cabeçalho e Navegação -->
        <header class="bg-blue-800 text-white shadow-lg sticky top-0 z-10">
            <div class="max-w-7xl mx-auto p-4 flex flex-col md:flex-row justify-between items-center">
                <h1 class="text-2xl font-bold tracking-tight mb-2 md:mb-0 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-2 h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="18" x2="12" y2="22"/></svg>
                    Gestão de Leads Angra
                </h1>
                <nav id="main-nav" class="flex space-x-2 sm:space-x-4">
                    <!-- Nav items will be dynamically injected here based on user role -->
                </nav>
                <div class="flex items-center space-x-4 mt-2 md:mt-0">
                    <div id="user-info-display" class="text-sm p-2 bg-blue-700 rounded-lg text-blue-200 shadow-inner hidden lg:block">
                        <!-- O nome e perfil do usuário serão injetados aqui -->
                    </div>
                    <button id="btn-logout" class="p-2 bg-red-500 hover:bg-red-600 text-white rounded-lg shadow-md transition-all text-sm flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        Sair
                    </button>
                </div>
            </div>
        </header>

        <!-- Conteúdo Principal -->
        <main class="flex-grow p-4 md:p-8">
            <div class="max-w-7xl mx-auto">
                <div id="view-dashboard" class="view-content space-y-8 hidden"></div>
                <div id="view-cadastro" class="view-content space-y-8 hidden"></div>
                <div id="view-historico" class="view-content space-y-8 hidden"></div>
                <div id="view-admin" class="view-content space-y-8 hidden"></div>
            </div>
        </main>

        <!-- Rodapé -->
        <footer class="bg-gray-900 text-white p-4 mt-8">
            <div id="footer-content" class="max-w-7xl mx-auto text-center text-sm text-gray-400">
                Sistema de Gestão de Leads Angra
            </div>
        </footer>
    </div>
    
    <!-- Tela de Carregamento Inicial -->
    <div id="loading-screen" class="flex justify-center items-center h-screen bg-gray-100 p-4">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 mx-auto text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-600 font-semibold">Conectando ao sistema...</p>
        </div>
    </div>
    
    <!-- Tela de Autenticação (Login/Cadastro) -->
    <div id="auth-screen" class="hidden flex justify-center items-center h-screen bg-gray-100 p-4">
        <div id="auth-card" class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl border border-gray-200">
            <!-- Conteúdo da autenticação será injetado aqui -->
        </div>
    </div>

    <!-- Firebase e JS Logic -->
    <script type="module">
        // Importações do Firebase via CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            addDoc, 
            updateDoc, 
            onSnapshot, 
            serverTimestamp, 
            doc, 
            getDocs,
            getDoc,
            setDoc,
            writeBatch, // Importado para transações em lote
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variáveis de Configuração e Globais ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gestaodeleadsangra';
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAY-rGNBHMsT5QqHHvNsZ9VzB3kyHtYPks",
            authDomain: "gestaodeleadsangra.firebaseapp.com",
            projectId: "gestaodeleadsangra",
            storageBucket: "gestaodeleadsangra.firebasestorage.app",
            messagingSenderId: "706992622509",
            appId: "1:706992622509:web:b091d4e27920d7d85e2f24"
        };
        
        const LEADS_COLLECTION_PATH = `artifacts/${appId}/public/data/leads`;
        const USERS_COLLECTION_PATH = `artifacts/${appId}/public/data/users`;

        let db;
        let auth;
        let currentUser = null; // Objeto completo do usuário logado {uid, name, role, email}
        let leadsData = [];
        let usersData = [];
        let currentView = 'cadastro';
        let unsubscribeLeads = () => {};
        let unsubscribeUsers = () => {};
        let filterState = { acao: '', dia: '', promotorId: '', converted: 'all' };


        const ROLES = { PROMOTOR: 'Promotor', QG: 'QG', LIDER_FDV: 'Líder/FDV' };
        const PERMISSION_LEVELS = { [ROLES.PROMOTOR]: 1, [ROLES.QG]: 2, [ROLES.LIDER_FDV]: 3 };
        const VIEW_PERMISSIONS = { 'dashboard': PERMISSION_LEVELS[ROLES.QG], 'cadastro': PERMISSION_LEVELS[ROLES.PROMOTOR], 'historico': PERMISSION_LEVELS[ROLES.QG], 'admin': PERMISSION_LEVELS[ROLES.LIDER_FDV] };

        // --- Helpers de UI e Formatação ---
        const formatCpf = (cpf) => cpf ? String(cpf).replace(/\D/g, '') : '';
        const formatPhone = (phone) => phone ? String(phone).replace(/\D/g, '') : '';
        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        };
        const generateIcon = (svgPath) => `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${svgPath}</svg>`;
        const ICONS = {
            USERS: generateIcon('<path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/>'),
            CHECK: generateIcon('<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>'),
            PERCENT: generateIcon('<line x1="19" y1="5" x2="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/>'),
            USER: generateIcon('<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>'),
            UPLOAD: generateIcon('<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>'),
            TAG: generateIcon('<path d="M20.59 13.41l-7.15 7.15a2.12 2.12 0 0 1-3-.01L3 13.25V4a1 1 0 0 1 1-1h9.25l7.34 7.34a2.12 2.12 0 0 1 0 3z"/><line x1="10" y1="10" x2="10.01" y2="10"/>'),
            PHONE: generateIcon('<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.08 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>'),
            MAIL: generateIcon('<path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>'),
            LIST: generateIcon('<line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>'),
            CALENDAR: generateIcon('<rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>'),
            HASH: generateIcon('<line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="15" x2="20" y2="15"/><line x1="10" y1="3" x2="8" y2="21"/><line x1="16" y1="3" x2="14" y2="21"/>'),
        };

        // --- Funções de Navegação e Renderização de UI ---
        function canView(viewName) {
            const requiredLevel = VIEW_PERMISSIONS[viewName];
            const userLevel = currentUser ? PERMISSION_LEVELS[currentUser.role] : 0;
            return userLevel >= requiredLevel;
        }

        function renderView(viewName) {
             if (!canView(viewName)) {
                if (canView('admin')) viewName = 'admin';
                else if (canView('dashboard')) viewName = 'dashboard';
                else viewName = 'cadastro'; 
            }
            document.querySelectorAll('.view-content').forEach(view => view.classList.add('hidden'));
            const targetView = document.getElementById(`view-${viewName}`);
            if (targetView) targetView.classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-blue-600', 'text-white');
                item.classList.add('text-blue-200', 'hover:bg-blue-700');
                if (item.dataset.view === viewName) {
                    item.classList.add('bg-blue-600', 'text-white');
                }
            });
            currentView = viewName;
            switch(viewName) {
                case 'dashboard': renderDashboard(); break;
                case 'cadastro': renderRegistration(); break;
                case 'historico': renderHistory(); break;
                case 'admin': renderAdminPanel(); break;
            }
        }

        function renderNav() {
            const nav = document.getElementById('main-nav');
            let navHTML = '';
            const navConfig = [
                { view: 'cadastro', label: 'Cadastrar', icon: ICONS.USER },
                { view: 'dashboard', label: 'Painel', icon: ICONS.CHECK },
                { view: 'historico', label: 'Histórico', icon: ICONS.LIST },
                { view: 'admin', label: 'Gerenciar', icon: ICONS.USER }
            ];

            navConfig.forEach(item => {
                if (canView(item.view)) {
                    navHTML += `<button class="nav-item flex items-center space-x-2 p-2 rounded-lg transition-all text-sm" data-view="${item.view}">
                        ${item.icon.replace('h-5 w-5 mr-2 inline-block', 'h-5 w-5')}
                        <span class="hidden sm:inline">${item.label}</span>
                    </button>`;
                }
            });
            nav.innerHTML = navHTML;
            
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.addEventListener('click', (e) => renderView(e.currentTarget.dataset.view));
            });
        }
        
        // --- 1. Inicialização do Firebase e Autenticação ---
        async function initApp() {
            try {
                // setLogLevel('debug');
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                }

                onAuthStateChanged(auth, async (user) => {
                    document.getElementById('loading-screen').classList.add('hidden');
                    if (user && !user.isAnonymous) {
                        await handleUserLogin(user);
                    } else {
                        handleUserLogout();
                    }
                });
                document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));
            } catch (error) {
                console.error("Erro na inicialização do Firebase:", error);
                document.getElementById('loading-screen').innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-lg">Erro fatal. Verifique o console.</div>`;
            }
        }
        
        async function handleUserLogin(user) {
            const userProfile = await fetchUserProfile(user.uid, user.email);
            currentUser = { uid: user.uid, email: user.email, ...userProfile };
            
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            document.getElementById('user-info-display').innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="gg-user"></i>
                    <span class="font-semibold">${currentUser.name || currentUser.email}</span>
                    <span class="text-xs bg-blue-500 px-2 py-0.5 rounded-full">${currentUser.role}</span>
                </div>
            `;
            document.getElementById('footer-content').innerText = "Sistema de Gestão de Leads | Criado por Marcos Teixeira";
            
            if (canView('dashboard')) {
                currentView = 'dashboard';
            } else {
                currentView = 'cadastro';
            }

            setupDataListeners();
            renderNav();
            renderView(currentView);
        }

        function handleUserLogout() {
            currentUser = null;
            leadsData = [];
            usersData = [];
            unsubscribeLeads();
            unsubscribeUsers();
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('auth-screen').classList.remove('hidden');
            renderAuthScreen(true);
        }

        async function fetchUserProfile(uid, email, name = null) {
            const userDocRef = doc(db, USERS_COLLECTION_PATH, uid);
            const userDocSnap = await getDoc(userDocRef);

            if (userDocSnap.exists()) {
                return userDocSnap.data();
            } else {
                // FIX: This block now handles the creation of the first user more robustly.
                let isFirstUser = false;
                try {
                    // This query checks if there are any other users in the database.
                    const usersQuery = query(collection(db, USERS_COLLECTION_PATH));
                    const allUsersSnapshot = await getDocs(usersQuery);
                    isFirstUser = allUsersSnapshot.empty;
                } catch (error) {
                    // If the query fails (e.g., on a brand new database), assume this is the first user.
                    // This prevents the registration from failing.
                    console.warn("Could not query users collection to determine role.", error);
                    console.warn("Assuming this is the first user registration and assigning Admin role.");
                    isFirstUser = true; 
                }

                const newRole = isFirstUser ? ROLES.LIDER_FDV : ROLES.PROMOTOR;
                const defaultName = email ? email.split('@')[0] : `user_${uid.substring(0, 6)}`;

                const newProfile = {
                    email: email,
                    role: newRole,
                    name: name || defaultName,
                    createdAt: serverTimestamp(),
                };
                await setDoc(userDocRef, newProfile);
                return newProfile;
            }
        }
        
        function renderAuthScreen(isLogin) {
            const authCard = document.getElementById('auth-card');
            authCard.innerHTML = `
                <h2 class="text-3xl font-extrabold text-gray-900 text-center mb-6">${isLogin ? 'Acesso ao Sistema' : 'Crie sua Conta'}</h2>
                <div id="auth-message" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg"></div>
                <form id="auth-form" class="space-y-4">
                    ${!isLogin ? renderInputField("Nome Completo", "auth-name", "text", true, "Seu nome e sobrenome", ICONS.USER) : ''}
                    ${renderInputField("Email", "auth-email", "email", true, "seu@email.com", ICONS.MAIL)}
                    ${renderInputField("Senha", "auth-password", "password", true, "Mínimo 6 caracteres", ICONS.HASH)}
                    <button type="submit" id="btn-auth-submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl">${isLogin ? 'Entrar' : 'Cadastrar'}</button>
                </form>
                <p class="mt-6 text-center text-sm text-gray-600">
                    ${isLogin ? "Não tem uma conta?" : "Já tem uma conta?"}
                    <button id="btn-toggle-auth" class="font-semibold text-blue-600 hover:text-blue-800">${isLogin ? "Crie uma conta" : "Faça Login"}</button>
                </p>`;
            document.getElementById('btn-toggle-auth').addEventListener('click', () => renderAuthScreen(!isLogin));
            document.getElementById('auth-form').addEventListener('submit', (e) => handleAuth(e, isLogin));
        }

        async function handleAuth(e, isLogin) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const name = !isLogin ? document.getElementById('auth-name').value : null;
            const msgEl = document.getElementById('auth-message');
            msgEl.classList.add('hidden');

            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    if (!name) {
                        msgEl.textContent = 'O campo "Nome Completo" é obrigatório.';
                        msgEl.classList.remove('hidden');
                        return;
                    }
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await fetchUserProfile(userCredential.user.uid, email, name);
                }
            } catch (error) {
                console.error("Authentication Error:", error);
                let msg = 'Ocorreu um erro. Verifique o console para mais detalhes.';
                if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                    msg = 'Email ou senha incorretos.';
                } else if (error.code === 'auth/email-already-in-use') {
                    msg = 'Este email já está cadastrado. Por favor, faça login.';
                } else if (error.code === 'auth/weak-password') {
                    msg = 'A senha deve ter pelo menos 6 caracteres.';
                } else if (error.code === 'auth/invalid-email') {
                    msg = 'O formato do email é inválido.';
                }
                msgEl.textContent = msg;
                msgEl.classList.remove('hidden');
            }
        }
        
        // --- 2. Listeners de Dados ---
        function setupDataListeners() {
            if (!db || !currentUser) return;
            const leadsQuery = query(collection(db, LEADS_COLLECTION_PATH));
            unsubscribeLeads = onSnapshot(leadsQuery, (snapshot) => {
                leadsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (document.getElementById('app-container').offsetParent !== null) {
                    renderView(currentView);
                }
            }, (error) => console.error("Erro ao ouvir leads:", error));

            const usersQuery = query(collection(db, USERS_COLLECTION_PATH));
            unsubscribeUsers = onSnapshot(usersQuery, (snapshot) => {
                usersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const myProfile = usersData.find(u => u.id === currentUser.uid);
                if (myProfile && (myProfile.role !== currentUser.role || myProfile.name !== currentUser.name)) {
                    currentUser = { ...currentUser, ...myProfile };
                    renderNav();
                    document.getElementById('user-info-display').innerHTML = `
                        <div class="flex items-center space-x-2">
                            <i class="gg-user"></i>
                            <span class="font-semibold">${currentUser.name || currentUser.email}</span>
                            <span class="text-xs bg-blue-500 px-2 py-0.5 rounded-full">${currentUser.role}</span>
                        </div>
                    `;
                }
                if (currentView === 'admin' || currentView === 'historico') renderView(currentView);
            }, (error) => console.error("Erro ao ouvir usuários:", error));
        }
        
        // --- 3. Dashboard ---
        function renderDashboard() {
            const stats = calculateStats();
            const dashboardEl = document.getElementById('view-dashboard');
            dashboardEl.innerHTML = `
                <h2 class="text-3xl font-extrabold text-gray-900 border-b-4 border-blue-500 pb-2 mb-4">Painel Principal</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    ${renderStatCard("Total de Leads", stats.totalLeads, ICONS.USERS, "bg-blue-500")}
                    ${renderStatCard("Leads Convertidos", stats.convertedLeads, ICONS.CHECK, "bg-green-500")}
                    ${renderStatCard("Taxa de Conversão", `${stats.conversionRate}%`, ICONS.PERCENT, "bg-purple-500")}
                    ${renderStatCard("Seus Leads", stats.userLeads, ICONS.USER, "bg-yellow-500")}
                </div>`;
        }

        function calculateStats() {
            const totalLeads = leadsData.length;
            const convertedLeads = leadsData.filter(lead => lead.converted).length;
            const userLeads = leadsData.filter(lead => lead.promotorId === currentUser.uid).length;
            const conversionRate = totalLeads > 0 ? ((convertedLeads / totalLeads) * 100).toFixed(1) : 0.0;
            return { totalLeads, convertedLeads, userLeads, conversionRate };
        }

        function renderStatCard(title, value, iconHTML, colorClass) {
            return `
                <div class="p-5 rounded-xl shadow-lg border-l-4 ${colorClass.replace('bg-', 'border-')} bg-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500 truncate">${title}</p>
                            <p class="mt-1 text-3xl font-bold text-gray-900">${value}</p>
                        </div>
                        <div class="p-3 rounded-full ${colorClass} bg-opacity-10 text-white">
                            ${iconHTML.replace('h-5 w-5 mr-2 inline-block', `h-6 w-6 ${colorClass.replace('bg', 'text')}`)}
                        </div>
                    </div>
                </div>`;
        }
        
        function showMessage(el, message, isError) {
            el.textContent = message;
            el.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            el.classList.add(isError ? 'bg-red-100' : 'bg-green-100', isError ? 'text-red-700' : 'text-green-700');
        }

        // --- 4. Cadastro de Leads ---
        function renderRegistration() {
            const formContainer = document.getElementById('view-cadastro');
            formContainer.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Formulário Individual -->
                    <div>
                        <h2 class="text-3xl font-extrabold text-gray-900 border-b-4 border-blue-500 pb-2 mb-4">Cadastro de Novo Lead</h2>
                        <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl border border-gray-100">
                             <div id="registration-message" class="hidden mb-4 p-3 rounded-lg text-center font-medium shadow-md"></div>
                             <form id="lead-form" class="space-y-4">
                                 ${renderInputField("Nome da Ação", "acao", "text", true, "Ex: Evento Junino", ICONS.TAG)}
                                 ${renderInputField("Nome Completo", "nome", "text", true, "", ICONS.USER)}
                                 ${renderInputField("Telefone (WhatsApp)", "telefone", "tel", true, "Apenas números com DDD", ICONS.PHONE)}
                                 ${renderInputField("Email", "email", "email", false, "exemplo@dominio.com", ICONS.MAIL)}
                                 ${renderInputField("CPF", "cpf", "text", false, "Apenas números", ICONS.HASH)}
                                 ${renderInputField("Curso de Interesse", "cursoInteresse", "text", false, "Ex: Engenharia", ICONS.LIST)}
                                 <button type="submit" id="btn-save-lead" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl">Salvar Novo Lead</button>
                             </form>
                        </div>
                    </div>
                    <!-- Importação em Lote -->
                    <div>
                        <h2 class="text-3xl font-extrabold text-gray-900 border-b-4 border-green-500 pb-2 mb-4">Importar Leads em Lote</h2>
                        <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl border border-gray-100 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Arquivo CSV</label>
                                <input type="file" id="csv-file-input" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                            </div>
                            <p class="text-xs text-gray-500">O arquivo deve ter as colunas: <code class="bg-gray-100 p-1 rounded">acao,nome,telefone,email,cpf,cursoInteresse</code>. A primeira linha deve ser o cabeçalho.</p>
                            <button id="btn-import-csv" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center">${ICONS.UPLOAD} <span>Importar Arquivo</span></button>
                            <div id="csv-import-results" class="mt-4 text-sm space-y-2"></div>
                        </div>
                    </div>
                </div>`;
            document.getElementById('lead-form').addEventListener('submit', handleSaveLead);
            document.getElementById('btn-import-csv').addEventListener('click', handleCSVImport);
        }
        
        function renderInputField(label, name, type, required, placeholder, iconHTML = '') {
            return `
                <div>
                    <label for="${name}" class="block text-sm font-medium text-gray-700 flex items-center">
                        ${iconHTML ? iconHTML.replace('h-5 w-5', 'h-4 w-4').replace('mr-2 inline-block', 'mr-1 text-blue-500') : ''}
                        ${label}
                        ${required ? '<span class="ml-1 text-red-500">*</span>' : ''}
                    </label>
                    <div class="mt-1">
                        <input type="${type}" name="${name}" id="${name}" ${required ? 'required' : ''} placeholder="${placeholder}" class="block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>`;
        }
        
        async function handleSaveLead(e) {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('btn-save-lead');
            const msgEl = document.getElementById('registration-message');
            
            msgEl.classList.add('hidden');
            btn.disabled = true;

            const formData = {
                acao: form.acao.value,
                nome: form.nome.value,
                telefone: form.telefone.value,
                email: form.email.value,
                cpf: form.cpf.value,
                cursoInteresse: form.cursoInteresse.value
            };

            if (!formData.acao || !formData.nome || !formData.telefone) {
                showMessage(msgEl, 'Por favor, preencha os campos obrigatórios.', true);
                btn.disabled = false;
                return;
            }

            const cleanedPhone = formatPhone(formData.telefone);
            const cleanedCpf = formatCpf(formData.cpf);

            const duplicateExists = leadsData.some(lead => {
                const isPhoneDuplicate = cleanedPhone && formatPhone(lead.telefone) === cleanedPhone;
                const isCpfDuplicate = cleanedCpf && formatCpf(lead.cpf) === cleanedCpf;
                return isPhoneDuplicate || isCpfDuplicate;
            });

            if (duplicateExists) {
                showMessage(msgEl, 'ERRO: Lead já cadastrado (Telefone ou CPF duplicado).', true);
                btn.disabled = false;
                return;
            }

            try {
                await addDoc(collection(db, LEADS_COLLECTION_PATH), {
                    ...formData,
                    telefone: cleanedPhone,
                    cpf: cleanedCpf,
                    converted: false,
                    createdAt: serverTimestamp(),
                    promotorId: currentUser.uid,
                    promotorName: currentUser.name
                });
                showMessage(msgEl, 'Lead cadastrado com sucesso!', false);
                form.reset();
            } catch (error) {
                console.error("Erro ao salvar o lead:", error);
                showMessage(msgEl, 'Erro ao salvar o lead. Tente novamente.', true);
            } finally {
                btn.disabled = false;
            }
        }

        async function handleCSVImport() {
            const fileInput = document.getElementById('csv-file-input');
            const resultsEl = document.getElementById('csv-import-results');
            const btn = document.getElementById('btn-import-csv');
            if (!fileInput.files.length) {
                resultsEl.innerHTML = `<p class="text-red-600 p-3 bg-red-50 rounded-lg">Por favor, selecione um arquivo CSV.</p>`;
                return;
            }
            btn.disabled = true;
            resultsEl.innerHTML = '';

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async (event) => {
                const text = event.target.result;
                const rows = text.split(/\r?\n/).filter(row => row.trim() !== '');
                if (rows.length < 2) {
                    resultsEl.innerHTML = `<p class="text-red-600 p-3 bg-red-50 rounded-lg">Arquivo CSV vazio ou sem dados.</p>`;
                    btn.disabled = false;
                    return;
                }

                const header = rows[0].split(',').map(h => h.trim());
                const leadsToImport = [];
                const errors = [];
                
                for (let i = 1; i < rows.length; i++) {
                    const values = rows[i].split(',');
                    const leadData = header.reduce((obj, key, index) => ({...obj, [key]: values[index] ? values[index].trim() : '' }), {});
                    
                    if (!leadData.acao || !leadData.nome || !leadData.telefone) {
                        errors.push(`Linha ${i + 1}: Campos obrigatórios (acao, nome, telefone) faltando.`);
                        continue;
                    }

                    const cleanedPhone = formatPhone(leadData.telefone);
                    const cleanedCpf = formatCpf(leadData.cpf);

                    if (leadsData.some(lead => formatPhone(lead.telefone) === cleanedPhone || (cleanedCpf && formatCpf(lead.cpf) === cleanedCpf))) {
                        errors.push(`Linha ${i + 1}: Lead com telefone ou CPF já existe no sistema.`);
                        continue;
                    }

                    leadsToImport.push({
                        ...leadData,
                        telefone: cleanedPhone,
                        cpf: cleanedCpf,
                        converted: false,
                        createdAt: serverTimestamp(),
                        promotorId: currentUser.uid,
                        promotorName: currentUser.name
                    });
                }

                if (leadsToImport.length > 0) {
                    try {
                        const batch = writeBatch(db);
                        leadsToImport.forEach(lead => {
                            const newLeadRef = doc(collection(db, LEADS_COLLECTION_PATH));
                            batch.set(newLeadRef, lead);
                        });
                        await batch.commit();
                        resultsEl.innerHTML += `<div class="p-3 bg-green-50 text-green-700 rounded-lg fade-in">${leadsToImport.length} leads importados com sucesso!</div>`;
                    } catch (error) {
                         resultsEl.innerHTML += `<div class="p-3 bg-red-50 text-red-700 rounded-lg fade-in">Erro ao salvar leads: ${error.message}</div>`;
                    }
                }
                
                if (errors.length > 0) {
                     resultsEl.innerHTML += `<div class="p-3 bg-yellow-50 text-yellow-700 rounded-lg mt-2 fade-in"><strong>Avisos:</strong><ul>${errors.map(e => `<li class="ml-4 list-disc">${e}</li>`).join('')}</ul></div>`;
                }

                fileInput.value = '';
                btn.disabled = false;
            };
            reader.readAsText(file);
        }

        // --- 5. Histórico de Leads ---
        function renderHistory() {
            const historyEl = document.getElementById('view-historico');
            const uniqueActions = [...new Set(leadsData.map(lead => lead.acao).filter(Boolean))].sort();
            const promotors = [...new Map(usersData.map(user => [user.id, user.name])).values()].filter(Boolean).sort();


            historyEl.innerHTML = `
                <h2 class="text-3xl font-extrabold text-gray-900 border-b-4 border-blue-500 pb-2 mb-4">Acesso e Histórico de Leads</h2>
                <div class="bg-white p-6 rounded-xl shadow-lg grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 border" id="filter-container">
                    ${renderFilterSelect("Ação", "acao", uniqueActions, filterState.acao, ICONS.TAG)}
                    ${renderFilterDate("Dia", "dia", filterState.dia, ICONS.CALENDAR)}
                    ${renderFilterSelect("Promotor", "promotorId", promotors, filterState.promotorId, ICONS.USER)}
                    ${renderFilterStatus("Status", "converted", filterState.converted, ICONS.CHECK)}
                    <div class='flex items-end'>
                        <button id="btn-clear-filters" class="w-full bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg">Limpar</button>
                    </div>
                </div>
                <div id="leads-table-container" class="mt-8"></div>
            `;
            
            document.getElementById('filter-container').addEventListener('change', (e) => handleFilterChange(e.target.name, e.target.value));
            document.getElementById('btn-clear-filters').addEventListener('click', handleClearFilters);
            
            renderLeadsTable();
        }
        
        function renderFilterSelect(label, name, options, currentValue, iconHTML) { return `<div><label for="${name}" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">${iconHTML.replace('h-5 w-5','h-4 w-4').replace('mr-2 inline-block','mr-1 text-blue-500')} ${label}</label><select id="${name}" name="${name}" class="block w-full rounded-lg border-gray-300 shadow-sm p-2 border"><option value="">-- Todos --</option>${options.map(opt => `<option value="${opt}" ${opt === currentValue ? 'selected' : ''}>${opt}</option>`).join('')}</select></div>`; }
        function renderFilterDate(label, name, currentValue, iconHTML) { return `<div><label for="${name}" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">${iconHTML.replace('h-5 w-5','h-4 w-4').replace('mr-2 inline-block','mr-1 text-blue-500')} ${label}</label><input type="date" name="${name}" id="${name}" value="${currentValue}" class="block w-full rounded-lg border-gray-300 shadow-sm p-2 border"/></div>`; }
        function renderFilterStatus(label, name, currentValue, iconHTML) { return `<div><label for="${name}" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">${iconHTML.replace('h-5 w-5','h-4 w-4').replace('mr-2 inline-block','mr-1 text-blue-500')} ${label}</label><select id="${name}" name="${name}" class="block w-full rounded-lg border-gray-300 shadow-sm p-2 border"><option value="all" ${currentValue === 'all' ? 'selected' : ''}>Todos</option><option value="true" ${currentValue === 'true' ? 'selected' : ''}>Convertido</option><option value="false" ${currentValue === 'false' ? 'selected' : ''}>Pendente</option></select></div>`; }

        function handleFilterChange(name, value) {
            filterState[name] = value;
            renderLeadsTable();
        }
        function handleClearFilters() {
            filterState = { acao: '', dia: '', promotorId: '', converted: 'all' };
            renderHistory();
        }

        function filterLeads() {
            let filtered = [...leadsData];
            if (filterState.acao) filtered = filtered.filter(lead => lead.acao === filterState.acao);
            if (filterState.dia) {
                const filterDate = new Date(filterState.dia);
                filtered = filtered.filter(lead => lead.createdAt && lead.createdAt.toDate().toDateString() === filterDate.toDateString());
            }
            if (filterState.promotorId) filtered = filtered.filter(lead => lead.promotorName === filterState.promotorId);
            if (filterState.converted !== 'all') filtered = filtered.filter(lead => String(lead.converted) === filterState.converted);
            return filtered.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
        }
        
        function renderLeadsTable() {
            const container = document.getElementById('leads-table-container');
            const filteredLeads = filterLeads();

            let tableHTML = `<div class="overflow-x-auto bg-white rounded-xl shadow-2xl border"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-blue-50"><tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ação/Data</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nome/Contato</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden sm:table-cell">Curso/Promotor</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Conversão</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Ações</th>
                </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;

            if (filteredLeads.length === 0) {
                tableHTML += `<tr><td colSpan="5" class="px-6 py-4 text-center text-gray-500">Nenhum lead encontrado.</td></tr>`;
            } else {
                filteredLeads.forEach(lead => {
                    const promotorName = lead.promotorName || usersData.find(u => u.id === lead.promotorId)?.name || 'Desconhecido';
                    tableHTML += `<tr class="hover:bg-blue-50">
                        <td class="px-6 py-4"><div class="font-medium text-gray-900">${lead.acao}</div><div class="text-xs text-gray-500">${formatDate(lead.createdAt)}</div></td>
                        <td class="px-6 py-4"><div class="font-semibold text-blue-600">${lead.nome}</div><div class="text-xs text-gray-500">${lead.telefone}</div></td>
                        <td class="px-6 py-4 hidden sm:table-cell"><div class="text-sm">${lead.cursoInteresse || 'N/A'}</div><div class="text-xs text-gray-500">${promotorName}</div></td>
                        <td class="px-6 py-4 text-center"><button data-lead-id="${lead.id}" data-status="${lead.converted}" class="toggle-conversion-btn px-3 py-1 rounded-full text-xs font-bold ${lead.converted ? 'bg-green-500 text-white' : 'bg-red-100 text-red-700'}">${lead.converted ? 'CONVERTIDO' : 'PENDENTE'}</button></td>
                        <td class="px-6 py-4 text-center"><a href="https://wa.me/55${lead.telefone}" target="_blank" class="text-green-600 hover:text-green-800">WhatsApp</a></td>
                    </tr>`;
                });
            }
            tableHTML += `</tbody></table></div>`;
            container.innerHTML = tableHTML;
            
            container.addEventListener('click', e => {
                if (e.target.classList.contains('toggle-conversion-btn')) {
                    const { leadId, status } = e.target.dataset;
                    handleConversionToggle(leadId, status === 'true');
                }
            })
        }

        async function handleConversionToggle(leadId, currentStatus) {
            if (!db) return;
            try {
                const docRef = doc(db, LEADS_COLLECTION_PATH, leadId);
                await updateDoc(docRef, { converted: !currentStatus });
            } catch (error) {
                console.error("Erro ao atualizar status:", error);
                alert("Você não tem permissão para alterar este lead.");
            }
        }
        
        // --- 6. Painel de Administração ---
        function renderAdminPanel() {
            const adminEl = document.getElementById('view-admin');
            adminEl.innerHTML = `
                <h2 class="text-3xl font-extrabold text-gray-900 border-b-4 border-blue-500 pb-2 mb-4">Gerenciamento de Usuários</h2>
                <div class="overflow-x-auto bg-white rounded-xl shadow-2xl border border-gray-100">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Perfil</th>
                                <th class="p-4 text-center text-xs font-medium text-gray-500 uppercase">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                            ${usersData.map(user => renderUserRow(user)).join('')}
                        </tbody>
                    </table>
                </div>`;
            
            adminEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('update-user-btn')) {
                    handleUserUpdate(e.target.dataset.uid);
                }
            });
        }

        function renderUserRow(user) {
            const isEditable = currentUser.role === ROLES.LIDER_FDV && user.id !== currentUser.uid;
            return `
                <tr class="hover:bg-blue-50">
                    <td class="p-4">
                        <input type="text" value="${user.name || ''}" class="name-input bg-gray-50 border rounded p-1 w-full" data-uid="${user.id}" ${!isEditable ? 'disabled' : ''}>
                    </td>
                    <td class="p-4 text-sm text-gray-600">${user.email}</td>
                    <td class="p-4">
                        <select class="role-selector bg-gray-50 border rounded p-1 w-full" data-uid="${user.id}" ${!isEditable ? 'disabled' : ''}>
                            ${Object.values(ROLES).map(role => `<option value="${role}" ${user.role === role ? 'selected' : ''}>${role}</option>`).join('')}
                        </select>
                    </td>
                    <td class="p-4 text-center">
                        ${isEditable ? `<button class="update-user-btn bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600" data-uid="${user.id}">Salvar</button>` : 'Não Editável'}
                    </td>
                </tr>`;
        }

        async function handleUserUpdate(uid) {
            const nameInput = document.querySelector(`.name-input[data-uid="${uid}"]`);
            const roleSelect = document.querySelector(`.role-selector[data-uid="${uid}"]`);
            const newName = nameInput.value.trim();
            const newRole = roleSelect.value;
            
            if (!newName) {
                alert('O nome do usuário não pode ficar em branco.');
                return;
            }

            try {
                const docRef = doc(db, USERS_COLLECTION_PATH, uid);
                await updateDoc(docRef, { name: newName, role: newRole });
                nameInput.classList.add('border-green-500', 'ring-green-500');
                setTimeout(() => nameInput.classList.remove('border-green-500', 'ring-green-500'), 2000);
            } catch (error) {
                console.error("Erro ao atualizar perfil:", error);
                nameInput.classList.add('border-red-500', 'ring-red-500');
                setTimeout(() => nameInput.classList.remove('border-red-500', 'ring-red-500'), 2000);
            }
        }
        
        // --- Inicialização ---
        window.addEventListener('load', initApp);
    </script>
</body>
</html>

