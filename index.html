<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Leads Angra</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) CDN -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- html2canvas CDN for image generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://css.gg/css?=|check|close|user|upload|search|tag|phone|mail|list|calendar|hash|briefcase|bookmark" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Estilos globais para a fonte e transições */
        body { font-family: 'Inter', sans-serif; }
        .transition-all { transition: all 0.3s ease-in-out; }
        /* Animação para resultados da importação */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        /* Estilo para botões de toggle de documento */
        .doc-toggle {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            min-width: 50px;
            text-align: center;
        }
        .doc-toggle.doc-sim {
            background-color: #10B981; /* green-500 */
            color: white;
            border-color: #059669; /* green-600 */
        }
        .doc-toggle.doc-nao {
            background-color: #FEE2E2; /* red-100 */
            color: #B91C1C; /* red-700 */
            border-color: #FCA5A5; /* red-300 */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Container Principal do App -->
    <div id="app-container" class="hidden">
        
        <!-- Cabeçalho e Navegação -->
        <header class="bg-blue-800 text-white shadow-lg sticky top-0 z-10">
            <div class="max-w-7xl mx-auto p-4 flex flex-col md:flex-row justify-between items-center">
                <h1 class="text-2xl font-bold tracking-tight mb-2 md:mb-0 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-2 h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="18" x2="12" y2="22"/></svg>
                    Gestão de Leads Angra
                </h1>
                <nav id="main-nav" class="flex space-x-2 sm:space-x-4">
                    <!-- Nav items will be dynamically injected here based on user role -->
                </nav>
                <div class="flex items-center space-x-4 mt-2 md:mt-0">
                    <div id="user-info-display" class="text-sm p-2 bg-blue-700 rounded-lg text-blue-200 shadow-inner hidden lg:block">
                        <!-- O nome e perfil do usuário serão injetados aqui -->
                    </div>
                    <button id="btn-logout" class="p-2 bg-red-500 hover:bg-red-600 text-white rounded-lg shadow-md transition-all text-sm flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        Sair
                    </button>
                </div>
            </div>
        </header>

        <!-- Conteúdo Principal -->
        <main class="flex-grow p-4 md:p-8">
            <div class="max-w-7xl mx-auto">
                <div id="view-dashboard" class="view-content space-y-8 hidden"></div>
                <div id="view-cadastro" class="view-content space-y-8 hidden"></div>
                <div id="view-historico" class="view-content space-y-8 hidden"></div>
                <div id="view-bases" class="view-content space-y-8 hidden"></div>
                <div id="view-controle-bases" class="view-content space-y-8 hidden"></div>
                <div id="view-gap" class="view-content space-y-8 hidden"></div>
                <div id="view-admin" class="view-content space-y-8 hidden"></div>
            </div>
        </main>

        <!-- Rodapé -->
        <footer class="bg-gray-900 text-white p-4 mt-8">
            <div id="footer-content" class="max-w-7xl mx-auto text-center text-sm text-gray-400">
                Sistema de Gestão de Leads Angra
            </div>
        </footer>
    </div>
    
    <!-- Tela de Carregamento Inicial -->
    <div id="loading-screen" class="flex justify-center items-center h-screen bg-gray-100 p-4">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 mx-auto text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-600 font-semibold">Conectando ao sistema...</p>
        </div>
    </div>
    
    <!-- Tela de Autenticação (Login/Cadastro) -->
    <div id="auth-screen" class="hidden flex justify-center items-center h-screen bg-gray-100 p-4">
        <div id="auth-card" class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl border border-gray-200">
            <!-- Conteúdo da autenticação será injetado aqui -->
        </div>
    </div>

    <!-- Toast Notification para substituir os alertas -->
    <div id="toast-notification" class="fixed top-5 right-5 bg-blue-600 text-white py-3 px-5 rounded-lg shadow-lg z-50 transform transition-transform duration-500 ease-in-out translate-x-[120%]">
        <p id="toast-message"></p>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirm-modal-overlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 flex justify-center items-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-lg font-bold text-gray-800">Confirmar Ação</h3>
            <p id="confirm-modal-message" class="my-4 text-gray-600"></p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-modal-cancel" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Firebase e JS Logic -->
    <script type="module">
        // Importações do Firebase via CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            addDoc, 
            updateDoc, 
            onSnapshot, 
            serverTimestamp, 
            doc, 
            getDocs,
            getDoc,
            setDoc,
            writeBatch,
            where,
            deleteDoc,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variáveis de Configuração e Globais ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gestaodeleadsangra-2cc1d';
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config !== "{}"
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "AIzaSyDucVe9OerO1nDpvMaMhWquyxkcco1GTZA",
                authDomain: "gestaodeleadsangra-2cc1d.firebaseapp.com",
                projectId: "gestaodeleadsangra-2cc1d",
                storageBucket: "gestaodeleadsangra-2cc1d.appspot.com",
                messagingSenderId: "914587846773",
                appId: "1:914587846773:web:fdd7dc3cc4fcf93529903c"
            };
        
        const LEADS_COLLECTION_PATH = `artifacts/${appId}/public/data/leads`;
        const USERS_COLLECTION_PATH = `artifacts/${appId}/public/data/users`;
        const GAP_COLLECTION_PATH = `artifacts/${appId}/public/data/gap_academico`;
        const PLANNER_COLLECTION_PATH = `artifacts/${appId}/public/data/planner`;
        const BASES_COLLECTION_PATH = `artifacts/${appId}/public/data/bases`;
        const BOM_DIA_CAPTACAO_COLLECTION_PATH = `artifacts/${appId}/public/data/bomDiaCaptacao`;
        const FORECAST_CAPTACAO_COLLECTION_PATH = `artifacts/${appId}/public/data/forecastCaptacao`;
        const CONTROLE_BASES_COLLECTION_PATH = `artifacts/${appId}/public/data/controleBases`;

        let db;
        let auth;
        let currentUser = null;
        let leadsData = [];
        let usersData = [];
        let gapData = [];
        let plannerData = [];
        let basesData = [];
        let bomDiaCaptacaoData = [];
        let forecastData = [];
        let controleBasesData = [];
        let currentView = 'cadastro';
        let isAuthReady = false;
        let unsubscribeLeads = () => {};
        let unsubscribeUsers = () => {};
        let unsubscribeGap = () => {};
        let unsubscribePlanner = () => {};
        let unsubscribeBases = () => {};
        let unsubscribeBomDiaCaptacao = () => {};
        let unsubscribeForecastCaptacao = () => {};
        let unsubscribeControleBases = () => {};
        
        let leadFilterState = { acao: '', dia: '', promotorId: '', converted: 'all', telefone: '', curso: '' };
        let gapFilterState = { nome: '', cpf: '', matAcad: 'all', gap: 'all', produto: '', curso: '', semestre: '', metodologia: '', formaIngresso: '' };
        let baseFilterState = { nome: '', cpf: '', produto: '', curso: '', nomeBase: '', status: 'all' };
        let controleBasesFilterState = { period: 'this_month', atendenteId: 'all', meioDisparo: 'all' };

        // --- Configuração de Perfis e Permissões ---
        const ROLES = { 
            PROMOTOR: 'Promotor', 
            FDV: 'FDV',
            SALA_MATRICULA: 'Sala de Matrícula',
            QG: 'QG', 
            LIDER_FDV: 'Líder/FDV' 
        };

        const VIEW_PERMISSIONS = { 
            'dashboard': [ROLES.PROMOTOR, ROLES.FDV, ROLES.SALA_MATRICULA, ROLES.QG, ROLES.LIDER_FDV],
            'cadastro':  [ROLES.PROMOTOR, ROLES.FDV, ROLES.SALA_MATRICULA, ROLES.QG, ROLES.LIDER_FDV], 
            'historico': [ROLES.FDV, ROLES.SALA_MATRICULA, ROLES.QG, ROLES.LIDER_FDV], 
            'bases':     [ROLES.SALA_MATRICULA, ROLES.QG, ROLES.LIDER_FDV],
            'controle-bases': [ROLES.SALA_MATRICULA, ROLES.QG, ROLES.LIDER_FDV],
            'gap':       [ROLES.SALA_MATRICULA, ROLES.LIDER_FDV],
            'admin':     [ROLES.LIDER_FDV] 
        };

        // --- Helpers de UI e Formatação ---
        const formatCpf = (cpf) => cpf ? String(cpf).replace(/\D/g, '') : '';
        const formatPhone = (phone) => phone ? String(phone).replace(/\D/g, '') : '';
        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        };

        function calculateWeekdays(startDate, endDate) {
            let count = 0;
            const currentDate = new Date(startDate.getTime());
            while (currentDate <= endDate) {
                const dayOfWeek = currentDate.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) { // 0 = Sunday, 6 = Saturday
                    count++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return count;
        }

        const generateIcon = (svgPath) => `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${svgPath}</svg>`;
        const ICONS = {
            USERS: generateIcon('<path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/>'),
            CHECK: generateIcon('<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>'),
            PERCENT: generateIcon('<line x1="19" y1="5" x2="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/>'),
            USER: generateIcon('<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>'),
            UPLOAD: generateIcon('<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>'),
            DOWNLOAD: generateIcon('<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>'),
            TAG: generateIcon('<path d="M20.59 13.41l-7.15 7.15a2.12 2.12 0 0 1-3-.01L3 13.25V4a1 1 0 0 1 1-1h9.25l7.34 7.34a2.12 2.12 0 0 1 0 3z"/><line x1="10" y1="10" x2="10.01" y2="10"/>'),
            PHONE: generateIcon('<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.08 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>'),
            MAIL: generateIcon('<path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>'),
            LIST: generateIcon('<line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>'),
            CALENDAR: generateIcon('<rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>'),
            HASH: generateIcon('<line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="15" x2="20" y2="15"/><line x1="10" y1="3" x2="8" y2="21"/><line x1="16" y1="3" x2="14" y2="21"/>'),
            ACADEMIC: generateIcon('<path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3.33 1.67 6.67 1.67 10 0v-5"/>'),
            DATABASE: generateIcon('<ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>'),
            BOOKMARK: generateIcon('<path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>'),
            CLOSE: generateIcon('<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>'),
        };
        
        // --- UI Helpers ---
        const toast = document.getElementById('toast-notification');
        const toastMessage = document.getElementById('toast-message');
        let toastTimeout;
        let confirmCallback = null;
        const confirmModal = document.getElementById('confirm-modal-overlay');
        const confirmMsg = document.getElementById('confirm-modal-message');

        function showToast(message, isError = false) {
            clearTimeout(toastTimeout);
            toastMessage.textContent = message;
            toast.classList.remove('bg-blue-600', 'bg-red-600');
            toast.classList.add(isError ? 'bg-red-600' : 'bg-blue-600');
            toast.classList.remove('translate-x-[120%]');
            toastTimeout = setTimeout(() => {
                toast.classList.add('translate-x-[120%]');
            }, 4000);
        }

        function showConfirm(message, callback) {
            confirmMsg.textContent = message;
            confirmCallback = callback;
            confirmModal.classList.remove('hidden');
        }

        document.getElementById('confirm-modal-cancel').addEventListener('click', () => {
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        });

        document.getElementById('confirm-modal-confirm').addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        });

        // --- Funções de Navegação e Renderização de UI ---
        function canView(viewName) {
            if (!currentUser || !VIEW_PERMISSIONS[viewName]) {
                return false;
            }
            return VIEW_PERMISSIONS[viewName].includes(currentUser.role);
        }

        function renderView(viewName) {
             if (!canView(viewName)) {
                 if(canView('dashboard')) viewName = 'dashboard';
                 else if (canView('cadastro')) viewName = 'cadastro';
                 else {
                     document.getElementById('app-container').innerHTML = '<p class="text-center p-8">Você não tem permissão para visualizar nenhuma página.</p>';
                     return;
                 }
             }
            document.querySelectorAll('.view-content').forEach(view => view.classList.add('hidden'));
            const targetView = document.getElementById(`view-${viewName}`);
            if (targetView) targetView.classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-blue-600', 'text-white');
                item.classList.add('text-blue-200', 'hover:bg-blue-700');
                if (item.dataset.view === viewName) {
                    item.classList.add('bg-blue-600', 'text-white');
                }
            });
            currentView = viewName;
            switch(viewName) {
                case 'dashboard': renderDashboard(); break;
                case 'cadastro': renderRegistration(); break;
                case 'historico': renderHistory(); break;
                case 'bases': renderBasesView(); break;
                case 'controle-bases': renderControleBasesView(); break;
                case 'gap': renderGapView(); break;
                case 'admin': renderAdminPanel(); break;
            }
        }

        function renderNav() {
            const nav = document.getElementById('main-nav');
            let navHTML = '';
            const navConfig = [
                { view: 'dashboard', label: 'Painel', icon: ICONS.CHECK },
                { view: 'cadastro', label: 'Leads', icon: ICONS.USER },
                { view: 'historico', label: 'Histórico', icon: ICONS.LIST },
                { view: 'bases', label: 'Bases', icon: ICONS.DATABASE },
                { view: 'controle-bases', label: 'Controle', icon: ICONS.BOOKMARK },
                { view: 'gap', label: 'GAP', icon: ICONS.ACADEMIC },
                { view: 'admin', label: 'Gerenciar', icon: ICONS.USERS }
            ];

            navConfig.forEach(item => {
                if (canView(item.view)) {
                    navHTML += `<button class="nav-item flex items-center space-x-2 p-2 rounded-lg transition-all text-sm" data-view="${item.view}">
                        ${item.icon.replace('h-5 w-5 mr-2 inline-block', 'h-5 w-5')}
                        <span class="hidden sm:inline">${item.label}</span>
                    </button>`;
                }
            });
            nav.innerHTML = navHTML;
            
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.addEventListener('click', (e) => renderView(e.currentTarget.dataset.view));
            });
        }
        
        // --- 1. Inicialização do Firebase e Autenticação ---
        async function initApp() {
            try {
                if (!firebaseConfig || !firebaseConfig.apiKey || !firebaseConfig.projectId) {
                    throw new Error("A configuração do Firebase (firebaseConfig) está ausente ou incompleta. A aplicação não pode ser iniciada.");
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                let customTokenAttempted = false;

                onAuthStateChanged(auth, async (user) => {
                    if (user && !user.isAnonymous) {
                        await handleUserLogin(user);
                    } else {
                        if (customTokenAttempted || (typeof __initial_auth_token === 'undefined' || !__initial_auth_token)) {
                            document.getElementById('loading-screen').classList.add('hidden');
                            handleUserLogout();
                        }
                    }
                });
                
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    customTokenAttempted = true;
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (authError) {
                        console.error("Erro ao autenticar com token customizado:", authError);
                        // O observer onAuthStateChanged vai lidar com o estado de não-logado.
                    }
                } else {
                    customTokenAttempted = true; // Se não há token, o estado inicial já pode ser decidido.
                }

                document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

            } catch (error) {
                console.error("ERRO CRÍTICO NA INICIALIZAÇÃO:", error);
                document.getElementById('loading-screen').innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-lg text-center"><strong>Erro Fatal</strong><br>${error.message}</div>`;
            }
        }
        
        async function handleUserLogin(user) {
            const userProfile = await fetchUserProfile(user.uid, user.email);
            currentUser = { uid: user.uid, email: user.email, ...userProfile };
            isAuthReady = true;
            
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            document.getElementById('user-info-display').innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="gg-user"></i>
                    <span class="font-semibold">${currentUser.name || currentUser.email}</span>
                    <span class="text-xs bg-blue-500 px-2 py-0.5 rounded-full">${currentUser.role}</span>
                </div>
            `;
            document.getElementById('footer-content').innerText = "Sistema de Gestão de Leads | Criado por Marcos Teixeira";
            
            renderNav();
            setupDataListeners();

            let initialView = 'cadastro';
            if (canView('dashboard')) {
                initialView = 'dashboard';
            }
            renderView(initialView);
        }

        function handleUserLogout() {
            currentUser = null;
            isAuthReady = false;
            leadsData = [];
            usersData = [];
            gapData = [];
            plannerData = [];
            bomDiaCaptacaoData = [];
            forecastData = [];
            controleBasesData = [];
            unsubscribeLeads();
            unsubscribeUsers();
            unsubscribeGap();
            unsubscribePlanner();
            unsubscribeBases();
            unsubscribeBomDiaCaptacao();
            unsubscribeForecastCaptacao();
            unsubscribeControleBases();
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('auth-screen').classList.remove('hidden');
            renderAuthScreen(true);
        }

        async function fetchUserProfile(uid, email, name = null) {
            const userDocRef = doc(db, USERS_COLLECTION_PATH, uid);
            const userDocSnap = await getDoc(userDocRef);

            if (userDocSnap.exists()) {
                return userDocSnap.data();
            } else {
                let isFirstUser = false;
                try {
                    const usersQuery = query(collection(db, USERS_COLLECTION_PATH));
                    const allUsersSnapshot = await getDocs(usersQuery);
                    isFirstUser = allUsersSnapshot.empty;
                } catch (error) {
                    console.warn("Could not query users collection to determine role.", error);
                    isFirstUser = true; 
                }

                const newRole = isFirstUser ? ROLES.LIDER_FDV : ROLES.PROMOTOR;
                const defaultName = email ? email.split('@')[0] : `user_${uid.substring(0, 6)}`;

                const newProfile = {
                    email: email,
                    role: newRole,
                    name: name || defaultName,
                    createdAt: serverTimestamp(),
                };
                await setDoc(userDocRef, newProfile);
                return newProfile;
            }
        }
        
        function renderAuthScreen(isLogin) {
            const authCard = document.getElementById('auth-card');
            authCard.innerHTML = `
                <h2 class="text-3xl font-extrabold text-gray-900 text-center mb-6">${isLogin ? 'Acesso ao Sistema' : 'Crie sua Conta'}</h2>
                <div id="auth-message" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg"></div>
                <form id="auth-form" class="space-y-4">
                    ${!isLogin ? renderInputField("Nome Completo", "auth-name", "text", true, "Seu nome e sobrenome", ICONS.USER) : ''}
                    ${renderInputField("Email", "auth-email", "email", true, "seu@email.com", ICONS.MAIL)}
                    ${renderInputField("Senha", "auth-password", "password", true, "Mínimo 6 caracteres", ICONS.HASH)}
                    <button type="submit" id="btn-auth-submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl">${isLogin ? 'Entrar' : 'Cadastrar'}</button>
                </form>
                <p class="mt-6 text-center text-sm text-gray-600">
                    ${isLogin ? "Não tem uma conta?" : "Já tem uma conta?"}
                    <button id="btn-toggle-auth" class="font-semibold text-blue-600 hover:text-blue-800">${isLogin ? "Crie uma conta" : "Faça Login"}</button>
                </p>`;
            document.getElementById('btn-toggle-auth').addEventListener('click', () => renderAuthScreen(!isLogin));
            document.getElementById('auth-form').addEventListener('submit', (e) => handleAuth(e, isLogin));
        }

        async function handleAuth(e, isLogin) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const name = !isLogin ? document.getElementById('auth-name').value : null;
            const msgEl = document.getElementById('auth-message');
            msgEl.classList.add('hidden');

            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    if (!name) {
                        msgEl.textContent = 'O campo "Nome Completo" é obrigatório.';
                        msgEl.classList.remove('hidden');
                        return;
                    }
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await fetchUserProfile(userCredential.user.uid, email, name);
                }
            } catch (error) {
                console.error("Authentication Error:", error);
                let msg = 'Ocorreu um erro.';
                if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                    msg = 'Email ou senha incorretos.';
                } else if (error.code === 'auth/email-already-in-use') {
                    msg = 'Este email já está cadastrado. Por favor, faça login.';
                } else if (error.code === 'auth/weak-password') {
                    msg = 'A senha deve ter pelo menos 6 caracteres.';
                } else if (error.code === 'auth/invalid-email') {
                    msg = 'O formato do email é inválido.';
                }
                msgEl.textContent = msg;
                msgEl.classList.remove('hidden');
            }
        }
        
        // --- 2. Listeners de Dados ---
        function setupDataListeners() {
            if (!db || !currentUser || !isAuthReady) {
                console.warn("A configuração dos listeners de dados foi abortada: a autenticação não está pronta.");
                return;
            }
            
            const usersQuery = query(collection(db, USERS_COLLECTION_PATH));
            unsubscribeUsers = onSnapshot(usersQuery, (snapshot) => {
                usersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const myProfile = usersData.find(u => u.id === currentUser.uid);
                if (myProfile && (myProfile.role !== currentUser.role || myProfile.name !== currentUser.name)) {
                    currentUser = { ...currentUser, ...myProfile };
                    renderNav();
                    document.getElementById('user-info-display').innerHTML = `
                        <div class="flex items-center space-x-2">
                            <i class="gg-user"></i>
                            <span class="font-semibold">${currentUser.name || currentUser.email}</span>
                            <span class="text-xs bg-blue-500 px-2 py-0.5 rounded-full">${currentUser.role}</span>
                        </div>`;
                }
                if (['admin', 'historico', 'cadastro', 'controle-bases'].includes(currentView)) renderView(currentView);
            }, (error) => console.error("Erro ao ouvir utilizadores:", error));

            let leadsQuery;
            const userRole = currentUser.role;

            if (userRole === ROLES.LIDER_FDV || userRole === ROLES.SALA_MATRICULA || userRole === ROLES.QG) {
                leadsQuery = query(collection(db, LEADS_COLLECTION_PATH));
            } else if (userRole === ROLES.FDV) {
                const promoterIds = usersData.filter(user => user.role === ROLES.PROMOTOR).map(user => user.id);
                const allowedIds = [...promoterIds, currentUser.uid];
                if (allowedIds.length > 0) {
                     leadsQuery = query(collection(db, LEADS_COLLECTION_PATH), where("promotorId", "in", allowedIds));
                }
            } else if (userRole === ROLES.PROMOTOR) {
                leadsQuery = query(collection(db, LEADS_COLLECTION_PATH), where("promotorId", "==", currentUser.uid));
            }

            if(leadsQuery) {
                unsubscribeLeads = onSnapshot(leadsQuery, (snapshot) => {
                    leadsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (['dashboard', 'historico', 'cadastro'].includes(currentView)) {
                        renderView(currentView);
                    }
                }, (error) => console.error("Erro ao ouvir leads:", error));
            }
            
            if (canView('bases')) {
                const basesQuery = query(collection(db, BASES_COLLECTION_PATH));
                unsubscribeBases = onSnapshot(basesQuery, (snapshot) => {
                    basesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (currentView === 'bases') renderView('bases');
                }, (error) => console.error("Erro ao ouvir bases:", error));
            }
            
            if (canView('controle-bases')) {
                const controleBasesQuery = query(collection(db, CONTROLE_BASES_COLLECTION_PATH));
                unsubscribeControleBases = onSnapshot(controleBasesQuery, (snapshot) => {
                    controleBasesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (currentView === 'controle-bases') renderView('controle-bases');
                }, (error) => console.error("Erro ao ouvir controle de bases:", error));
            }

            if (canView('gap')) {
                const gapQuery = query(collection(db, GAP_COLLECTION_PATH));
                unsubscribeGap = onSnapshot(gapQuery, (snapshot) => {
                    gapData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (currentView === 'gap') renderView('gap');
                }, (error) => console.error("Erro ao ouvir GAP:", error));
            }

            if (canView('dashboard') || canView('admin')) {
                const plannerQuery = query(collection(db, PLANNER_COLLECTION_PATH));
                unsubscribePlanner = onSnapshot(plannerQuery, (snapshot) => {
                    plannerData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (['dashboard', 'admin'].includes(currentView)) {
                        renderView(currentView);
                    }
                }, (error) => console.error("Erro ao ouvir planner:", error));
                
                const captacaoQuery = query(collection(db, BOM_DIA_CAPTACAO_COLLECTION_PATH));
                unsubscribeBomDiaCaptacao = onSnapshot(captacaoQuery, (snapshot) => {
                    bomDiaCaptacaoData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (currentView === 'dashboard' || currentView === 'admin') {
                        renderView(currentView);
                    }
                }, (error) => console.error("Erro ao ouvir Bom Dia Captação:", error));

                const forecastQuery = query(collection(db, FORECAST_CAPTACAO_COLLECTION_PATH));
                unsubscribeForecastCaptacao = onSnapshot(forecastQuery, (snapshot) => {
                    forecastData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (currentView === 'dashboard' || currentView === 'admin') {
                        renderView(currentView);
                    }
                }, (error) => console.error("Erro ao ouvir Forecast Captação:", error));
            }
        }
        
        // --- 3. Dashboard ---
        function renderDashboard() {
            const dashboardEl = document.getElementById('view-dashboard');
            dashboardEl.innerHTML = `
                <h2 class="text-3xl font-extrabold text-gray-900 border-b-4 border-blue-500 pb-2 mb-8">Bom Dia Captação</h2>
                <div id="bom-dia-captacao-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
                    ${renderBomDiaCaptacaoCards()}
                </div>
                <div class="mt-12">
                    <h2 class="text-3xl font-extrabold text-gray-900 border-b-4 border-purple-500 pb-2 mb-8">Forecast da Captação</h2>
                    <div id="forecast-captacao-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
                        ${renderForecastCaptacaoCards()}
                    </div>
                </div>
                <div class="mt-12">
                    <h2 class="text-3xl font-extrabold text-gray-900 border-b-4 border-green-500 pb-2 mb-4">Planner da Semana</h2>
                    <div id="planner-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        ${renderPlannerView()}
                    </div>
                </div>
            `;

             // Event listener for share buttons
            const captacaoContainer = document.getElementById('bom-dia-captacao-container');
            if (captacaoContainer) {
                captacaoContainer.addEventListener('click', (e) => {
                    const shareButton = e.target.closest('.share-captacao-btn');
                    if (shareButton) {
                        const cardId = shareButton.dataset.cardId;
                        handleShareCaptacao(cardId);
                    }
                });
            }
        }
        
        function renderBomDiaCaptacaoCards() {
            if (!bomDiaCaptacaoData || bomDiaCaptacaoData.length === 0) {
                return '<div class="col-span-full bg-white p-6 rounded-xl shadow-lg border text-center text-gray-500">Nenhum dado de captação para exibir. Adicione na aba Gerenciar.</div>';
            }

            const calculateMetrics = (real, meta, anterior) => {
                const percMeta = meta > 0 ? (real / meta) : 0;
                const percAnterior = anterior > 0 ? (real / anterior) : 0;
                const gapMeta = real - meta;
                const gapAnterior = real - anterior;
                return { percMeta, percAnterior, gapMeta, gapAnterior };
            };
            
            const formatNum = (val) => new Intl.NumberFormat('pt-BR').format(val);
            const formatPercent = (val) => new Intl.NumberFormat('pt-BR', { style: 'percent', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(val);
            const formatGap = (val) => val > 0 ? `+${formatNum(val)}` : formatNum(val);
            const gapColor = (val) => val >= 0 ? 'text-green-600' : 'text-red-600';
            const percentColor = (val) => val >= 1 ? 'text-green-600' : 'text-red-600';

            return bomDiaCaptacaoData.sort((a,b) => a.title.localeCompare(b.title)).map(item => {
                const insc = calculateMetrics(item.real.insc, item.metaDia.insc, item.anoAnterior.insc);
                const matFin = calculateMetrics(item.real.matFin, item.metaDia.matFin, item.anoAnterior.matFin);
                const matAcad = calculateMetrics(item.real.matAcad, item.metaDia.matAcad, item.anoAnterior.matAcad);

                return `
                <div class="bg-white p-4 rounded-xl shadow-lg border-t-4 border-blue-500 col-span-1" id="captacao-card-${item.id}">
                    <h3 class="font-bold text-center text-gray-800 mb-4">${item.title}</h3>
                    <table class="w-full text-sm text-center">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-2 font-semibold text-gray-600 text-left">Métrica</th>
                                <th class="p-2 font-semibold text-gray-600">INSC</th>
                                <th class="p-2 font-semibold text-gray-600">MAT FIN</th>
                                <th class="p-2 font-semibold text-gray-600">MAT ACAD</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <tr class="text-gray-500">
                                <td class="p-2 text-left font-medium">META DIA</td>
                                <td>${formatNum(item.metaDia.insc)}</td>
                                <td>${formatNum(item.metaDia.matFin)}</td>
                                <td>${formatNum(item.metaDia.matAcad)}</td>
                            </tr>
                            <tr class="text-gray-500">
                                <td class="p-2 text-left font-medium">ANO ANTERIOR</td>
                                <td>${formatNum(item.anoAnterior.insc)}</td>
                                <td>${formatNum(item.anoAnterior.matFin)}</td>
                                <td>${formatNum(item.anoAnterior.matAcad)}</td>
                            </tr>
                            <tr class="bg-blue-50 font-bold text-blue-800">
                                <td class="p-2 text-left">REAL</td>
                                <td>${formatNum(item.real.insc)}</td>
                                <td>${formatNum(item.real.matFin)}</td>
                                <td>${formatNum(item.real.matAcad)}</td>
                            </tr>
                            <tr>
                                <td class="p-2 text-left font-medium text-gray-500">% META DIA</td>
                                <td class="${percentColor(insc.percMeta)} font-semibold">${formatPercent(insc.percMeta)}</td>
                                <td class="${percentColor(matFin.percMeta)} font-semibold">${formatPercent(matFin.percMeta)}</td>
                                <td class="${percentColor(matAcad.percMeta)} font-semibold">${formatPercent(matAcad.percMeta)}</td>
                            </tr>
                            <tr>
                                <td class="p-2 text-left font-medium text-gray-500">% ANO ANT.</td>
                                <td class="${percentColor(insc.percAnterior)} font-semibold">${formatPercent(insc.percAnterior)}</td>
                                <td class="${percentColor(matFin.percAnterior)} font-semibold">${formatPercent(matFin.percAnterior)}</td>
                                <td class="${percentColor(matAcad.percAnterior)} font-semibold">${formatPercent(matAcad.percAnterior)}</td>
                            </tr>
                            <tr>
                                <td class="p-2 text-left font-medium text-gray-500">GAP META DIA</td>
                                <td class="${gapColor(insc.gapMeta)} font-semibold">${formatGap(insc.gapMeta)}</td>
                                <td class="${gapColor(matFin.gapMeta)} font-semibold">${formatGap(matFin.gapMeta)}</td>
                                <td class="${gapColor(matAcad.gapMeta)} font-semibold">${formatGap(matAcad.gapMeta)}</td>
                            </tr>
                             <tr>
                                <td class="p-2 text-left font-medium text-gray-500">GAP ANO ANT.</td>
                                <td class="${gapColor(insc.gapAnterior)} font-semibold">${formatGap(insc.gapAnterior)}</td>
                                <td class="${gapColor(matFin.gapAnterior)} font-semibold">${formatGap(matFin.gapAnterior)}</td>
                                <td class="${gapColor(matAcad.gapAnterior)} font-semibold">${formatGap(matAcad.gapAnterior)}</td>
                            </tr>
                        </tbody>
                    </table>
                     <div class="mt-4 pt-4 border-t border-gray-200 text-center">
                        <button data-card-id="${item.id}" class="share-captacao-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center w-full">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
                            <span>Compartilhar</span>
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }

        async function handleShareCaptacao(cardId) {
            const cardElement = document.getElementById(`captacao-card-${cardId}`);
            if (!cardElement) {
                showToast('Erro ao encontrar o card para compartilhar.', true);
                return;
            }

            showToast('Gerando imagem para compartilhar...');

            try {
                const canvas = await html2canvas(cardElement, { useCORS: true, scale: 2 });
                const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
                
                const newWindow = window.open();
                newWindow.document.write(`<img src="${dataUrl}" alt="Dashboard Image" style="width:100%;">`);
                showToast('Imagem pronta! Salve e compartilhe no WhatsApp.', false);

            } catch (error) {
                console.error('Erro ao gerar imagem:', error);
                showToast('Ocorreu um erro ao gerar a imagem.', true);
            }
        }


        function renderForecastCaptacaoCards() {
            if (!forecastData || forecastData.length === 0) {
                return '<div class="col-span-full bg-white p-6 rounded-xl shadow-lg border text-center text-gray-500">Nenhum dado de forecast para exibir. Adicione na aba Gerenciar.</div>';
            }
            
            const formatNum = (val) => new Intl.NumberFormat('pt-BR').format(val);
            const formatPercent = (val) => new Intl.NumberFormat('pt-BR', { style: 'percent', minimumFractionDigits: 1, maximumFractionDigits: 1 }).format(val);
            const formatGap = (val) => val > 0 ? `+${formatNum(val)}` : formatNum(val);
            const gapColor = (val) => val >= 0 ? 'text-green-600' : 'text-red-600';
            const percentColor = (val) => val >= 1 ? 'text-green-600' : 'text-orange-500';

            return forecastData.sort((a,b) => a.title.localeCompare(b.title)).map(item => {
                const realVsYtd = item.ytd > 0 ? item.real / item.ytd : 0;
                const projVsMeta = item.meta > 0 ? item.projecao / item.meta : 0;
                const gap = item.real - item.projecao;

                let pacingDiario = 0;
                if(item.dataInicio && item.dataFim) {
                    const inicio = new Date(item.dataInicio + "T00:00:00");
                    const fim = new Date(item.dataFim + "T00:00:00");
                    const hoje = new Date();
                    hoje.setHours(0, 0, 0, 0);

                    if (hoje <= fim && hoje >= inicio) {
                        const diasRestantes = calculateWeekdays(hoje, fim);
                        const gapParaMeta = item.meta - item.real;
                        if(gapParaMeta > 0 && diasRestantes > 0) {
                            pacingDiario = gapParaMeta / diasRestantes;
                        }
                    }
                }


                return `
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-purple-500 col-span-1">
                    <h3 class="font-bold text-center text-gray-800 text-lg mb-4">${item.title}</h3>
                    <div class="space-y-4 text-sm">
                        <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                            <span class="font-semibold text-gray-600">YTD</span>
                            <span class="font-bold text-gray-800">${formatNum(item.ytd)}</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                            <span class="font-semibold text-gray-600">REAL</span>
                            <span class="font-bold text-blue-600 text-base">${formatNum(item.real)}</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                            <span class="font-semibold text-gray-600">REAL vs YTD</span>
                            <span class="font-bold ${percentColor(realVsYtd)}">${formatPercent(realVsYtd)}</span>
                        </div>
                        <div class="border-t my-2"></div>
                        <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                            <span class="font-semibold text-gray-600">META FECHAMENTO</span>
                            <span class="font-bold text-gray-800">${formatNum(item.meta)}</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                            <span class="font-semibold text-gray-600">PROJEÇÃO</span>
                            <span class="font-bold text-blue-600 text-base">${formatNum(item.projecao)}</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                            <span class="font-semibold text-gray-600">PROJEÇÃO vs META</span>
                            <span class="font-bold ${percentColor(projVsMeta)}">${formatPercent(projVsMeta)}</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                            <span class="font-semibold text-gray-600">GAP P/ FECHAMENTO</span>
                            <span class="font-bold ${gapColor(gap)}">${formatGap(gap)}</span>
                        </div>
                        <div class="border-t my-2"></div>
                        <div class="flex justify-between items-center bg-purple-50 p-3 rounded">
                            <span class="font-semibold text-purple-800">PACING DIÁRIO</span>
                            <span class="font-bold text-purple-800 text-lg">${pacingDiario.toFixed(1)}</span>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }


        function calculateStats() {
            const totalLeads = leadsData.length;
            const convertedLeads = leadsData.filter(lead => lead.converted).length;
            const userLeads = leadsData.filter(lead => lead.promotorId === currentUser.uid).length;
            const conversionRate = totalLeads > 0 ? ((convertedLeads / totalLeads) * 100).toFixed(1) : 0.0;
            return { totalLeads, convertedLeads, userLeads, conversionRate };
        }

        function renderStatCard(title, value, iconHTML, colorClass) {
            return `
                <div class="p-5 rounded-xl shadow-lg border-l-4 ${colorClass.replace('bg-', 'border-')} bg-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500 truncate">${title}</p>
                            <p class="mt-1 text-3xl font-bold text-gray-900">${value}</p>
                        </div>
                        <div class="p-3 rounded-full ${colorClass} bg-opacity-10 text-white">
                            ${iconHTML.replace('h-5 w-5 mr-2 inline-block', `h-6 w-6 ${colorClass.replace('bg', 'text')}`)}
                        </div>
                    </div>
                </div>`;
        }
        
        function renderPlannerView() {
            const daysOfWeek = ["Segunda-feira", "Terça-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "Sábado", "Domingo"];
            if (plannerData.length === 0) {
                return '<div class="col-span-full bg-white p-6 rounded-xl shadow-lg border text-center text-gray-500">Nenhuma tarefa agendada para esta semana.</div>';
            }

            let html = '';
            daysOfWeek.forEach(day => {
                const tasksForDay = plannerData.filter(task => task.dayOfWeek === day);
                if (tasksForDay.length > 0) {
                    html += `
                        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-500 flex flex-col">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">${day}</h3>
                            <div class="space-y-4 flex-grow">
                    `;
                    tasksForDay.forEach(task => {
                        const baseDisplay = task.baseLink 
                            ? `<a href="${task.baseLink}" target="_blank" class="text-blue-600 hover:underline font-semibold">${task.baseName}</a>`
                            : `<span class="font-semibold">${task.baseName}</span>`;

                        html += `
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center mb-2">
                                    ${ICONS.USER.replace('h-5 w-5', 'h-4 w-4').replace('mr-2 inline-block', 'mr-2 text-blue-500')}
                                    <span class="font-semibold text-gray-700">${task.atendenteName}</span>
                                </div>
                                <div class="flex items-start text-gray-600">
                                     ${ICONS.LIST.replace('h-5 w-5', 'h-4 w-4').replace('mr-2 inline-block', 'mr-2 text-green-500 mt-1')}
                                     <span>Trabalhar Base: ${baseDisplay}</span>
                                </div>
                            </div>
                        `;
                    });
                    html += `</div></div>`;
                }
            });

            return html || '<div class="col-span-full bg-white p-6 rounded-xl shadow-lg border text-center text-gray-500">Nenhuma tarefa agendada.</div>';
        }

        function showMessage(el, message, isError) {
            el.textContent = message;
            el.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            el.classList.add(isError ? 'bg-red-100' : 'bg-green-100', isError ? 'text-red-700' : 'text-green-700');
        }

        // --- 4. Cadastro de Leads ---
        function renderRegistration() {
            const formContainer = document.getElementById('view-cadastro');
            formContainer.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-3xl font-extrabold text-gray-900 border-b-4 border-blue-500 pb-2">Cadastro de Leads</h2>
                    <a href="https://estacioangra.my.canva.site/c-pia-de-cat-logo-de-cursos-pdf-clic-vel" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all">
                        Conheça nossos Cursos
                    </a>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Novo Lead Individual</h3>
                        <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl border border-gray-100">
                             <div id="registration-message" class="hidden mb-4 p-3 rounded-lg text-center font-medium shadow-md"></div>
                             <form id="lead-form" class="space-y-4">
                                 ${renderInputField("Nome da Ação", "acao", "text", true, "Ex: Evento Junino", ICONS.TAG)}
                                 ${renderInputField("Nome Completo", "nome", "text", true, "", ICONS.USER)}
                                 ${renderInputField("Telefone (WhatsApp)", "telefone", "tel", true, "Apenas números com DDD", ICONS.PHONE)}
                                 ${renderInputField("Email", "email", "email", false, "exemplo@dominio.com", ICONS.MAIL)}
                                 ${renderInputField("CPF", "cpf", "text", false, "Apenas números", ICONS.HASH)}
                                 ${renderInputField("Curso de Interesse", "cursoInteresse", "text", false, "Ex: Engenharia", ICONS.LIST)}
                                 <button type="submit" id="btn-save-lead" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl">Salvar Novo Lead</button>
                             </form>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Importar Leads em Lote (Excel)</h3>
                        <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl border border-gray-100 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Arquivo Excel (.xlsx)</label>
                                <input type="file" id="file-import-input" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                            </div>
                            <p class="text-xs text-gray-500">O arquivo deve ter as colunas: <code class="bg-gray-100 p-1 rounded">acao,nome,telefone,email,cpf,cursoInteresse</code>.</p>
                            <button id="btn-import-file" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center">${ICONS.UPLOAD} <span>Importar Arquivo</span></button>
                            <div id="file-import-results" class="mt-4 text-sm space-y-2"></div>
                        </div>
                    </div>
                </div>`;
            document.getElementById('lead-form').addEventListener('submit', handleSaveLead);
            document.getElementById('btn-import-file').addEventListener('click', handleFileImport);
        }
        
        function renderInputField(label, name, type, required, placeholder, iconHTML = '') {
            return `
                <div>
                    <label for="${name}" class="block text-sm font-medium text-gray-700 flex items-center">
                        ${iconHTML ? iconHTML.replace('h-5 w-5', 'h-4 w-4').replace('mr-2 inline-block', 'mr-1 text-blue-500') : ''}
                        ${label}
                        ${required ? '<span class="ml-1 text-red-500">*</span>' : ''}
                    </label>
                    <div class="mt-1">
                        <input type="${type}" name="${name}" id="${name}" ${required ? 'required' : ''} placeholder="${placeholder}" class="block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>`;
        }

        function renderSelectField(label, name, options, required, iconHTML = '') {
            return `
                <div>
                    <label for="${name}" class="block text-sm font-medium text-gray-700 flex items-center">
                        ${iconHTML ? iconHTML.replace('h-5 w-5', 'h-4 w-4').replace('mr-2 inline-block', 'mr-1 text-blue-500') : ''}
                        ${label}
                        ${required ? '<span class="ml-1 text-red-500">*</span>' : ''}
                    </label>
                    <div class="mt-1">
                        <select id="${name}" name="${name}" ${required ? 'required' : ''} class="block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-blue-500 focus:border-blue-500">
                           <option value="">-- Selecione --</option>
                           ${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                        </select>
                    </div>
                </div>`;
        }
        
        async function handleSaveLead(e) {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('btn-save-lead');
            const msgEl = document.getElementById('registration-message');
            
            msgEl.classList.add('hidden');
            btn.disabled = true;

            const formData = {
                acao: form.acao.value,
                nome: form.nome.value,
                telefone: form.telefone.value,
                email: form.email.value,
                cpf: form.cpf.value,
                cursoInteresse: form.cursoInteresse.value
            };

            if (!formData.acao || !formData.nome || !formData.telefone) {
                showMessage(msgEl, 'Por favor, preencha os campos obrigatórios.', true);
                btn.disabled = false;
                return;
            }

            const cleanedPhone = formatPhone(formData.telefone);
            const cleanedCpf = formatCpf(formData.cpf);

            const duplicateExists = leadsData.some(lead => {
                const isPhoneDuplicate = cleanedPhone && formatPhone(lead.telefone) === cleanedPhone;
                const isCpfDuplicate = cleanedCpf && formatCpf(lead.cpf) === cleanedCpf;
                return isPhoneDuplicate || isCpfDuplicate;
            });

            if (duplicateExists) {
                showMessage(msgEl, 'ERRO: Lead já cadastrado (Telefone ou CPF duplicado).', true);
                btn.disabled = false;
                return;
            }

            try {
                await addDoc(collection(db, LEADS_COLLECTION_PATH), {
                    ...formData,
                    telefone: cleanedPhone,
                    cpf: cleanedCpf,
                    converted: false,
                    createdAt: serverTimestamp(),
                    promotorId: currentUser.uid,
                    promotorName: currentUser.name
                });
                showMessage(msgEl, 'Lead cadastrado com sucesso!', false);
                form.reset();
            } catch (error) {
                console.error("Erro ao salvar o lead:", error);
                showMessage(msgEl, 'Erro ao salvar o lead. Tente novamente.', true);
            } finally {
                btn.disabled = false;
            }
        }

        async function handleFileImport() {
            const fileInput = document.getElementById('file-import-input');
            const resultsEl = document.getElementById('file-import-results');
            const btn = document.getElementById('btn-import-file');
            if (!fileInput.files.length) {
                resultsEl.innerHTML = `<p class="text-red-600 p-3 bg-red-50 rounded-lg">Selecione um arquivo Excel.</p>`;
                return;
            }
            btn.disabled = true;
            btn.innerHTML = 'Processando...';
            resultsEl.innerHTML = '';

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async (event) => {
                const errors = [];
                const leadsToImport = [];

                try {
                    const data = event.target.result;
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonLeads = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (jsonLeads.length === 0) {
                        errors.push("O arquivo Excel parece estar vazio.");
                    } else {
                        jsonLeads.forEach((leadData, index) => {
                            const lineNumber = index + 2;
                            if (!leadData.acao || !leadData.nome || !leadData.telefone) {
                                errors.push(`Linha ${lineNumber}: Campos (acao, nome, telefone) faltando.`);
                                return;
                            }
                            const cleanedPhone = formatPhone(leadData.telefone);
                            const cleanedCpf = formatCpf(leadData.cpf);
                            if (leadsData.some(lead => formatPhone(lead.telefone) === cleanedPhone || (cleanedCpf && formatCpf(lead.cpf) === cleanedCpf))) {
                                errors.push(`Linha ${lineNumber}: Lead com telefone ou CPF já existe.`);
                                return;
                            }
                            leadsToImport.push({
                                ...leadData,
                                telefone: cleanedPhone,
                                cpf: cleanedCpf,
                                converted: false,
                                createdAt: serverTimestamp(),
                                promotorId: currentUser.uid,
                                promotorName: currentUser.name
                            });
                        });
                    }

                    if (leadsToImport.length > 0) {
                        const batch = writeBatch(db);
                        leadsToImport.forEach(lead => {
                            const newLeadRef = doc(collection(db, LEADS_COLLECTION_PATH));
                            batch.set(newLeadRef, lead);
                        });
                        await batch.commit();
                        resultsEl.innerHTML += `<div class="p-3 bg-green-50 text-green-700 rounded-lg fade-in">${leadsToImport.length} leads importados com sucesso!</div>`;
                    }
                } catch (error) {
                    errors.push(`Erro ao processar o arquivo: ${error.message}`);
                } finally {
                    if (errors.length > 0) {
                        resultsEl.innerHTML += `<div class="p-3 bg-yellow-50 text-yellow-700 rounded-lg mt-2 fade-in"><strong>Avisos:</strong><ul>${errors.map(e => `<li class="ml-4 list-disc">${e}</li>`).join('')}</ul></div>`;
                    }
                    fileInput.value = '';
                    btn.disabled = false;
                    btn.innerHTML = `${ICONS.UPLOAD} <span>Importar Arquivo</span>`;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- 5. Histórico de Leads ---
        function renderHistory() {
            const historyEl = document.getElementById('view-historico');
            const stats = calculateStats();
            const uniqueActions = [...new Set(leadsData.map(lead => lead.acao).filter(Boolean))].sort();
            
            let promotors = [];
            if (currentUser.role === ROLES.FDV) {
                promotors = usersData.filter(u => u.role === ROLES.PROMOTOR || u.id === currentUser.uid).map(u => u.name);
            } else {
                promotors = [...new Map(usersData.map(user => [user.id, user.name])).values()].filter(Boolean).sort();
            }

            const uniqueCourses = [...new Set(leadsData.map(lead => lead.cursoInteresse).filter(Boolean))].sort();

            historyEl.innerHTML = `
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    ${renderStatCard("Total de Leads (Visíveis)", stats.totalLeads, ICONS.USERS, "bg-blue-500")}
                    ${renderStatCard("Leads Convertidos", stats.convertedLeads, ICONS.CHECK, "bg-green-500")}
                    ${renderStatCard("Taxa de Conversão", `${stats.conversionRate}%`, ICONS.PERCENT, "bg-purple-500")}
                    ${renderStatCard("Seus Leads", stats.userLeads, ICONS.USER, "bg-yellow-500")}
                </div>

                <div class="flex justify-between items-center mb-4">
                     <h2 class="text-3xl font-extrabold text-gray-900 border-b-4 border-blue-500 pb-2">Filtros e Histórico</h2>
                     <a href="https://estacio-my.sharepoint.com/:o:/g/personal/marcos_teixeira_estacio_br/EuQ7eSP7m8ZMothtgQfTswEB_48PoRTW4RMo7Jbn8udkzg?e=JLQ370" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                         Mensagens para usar
                     </a>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 border" id="filter-container">
                    ${renderFilterSelect("Ação", "acao", uniqueActions, leadFilterState.acao, ICONS.TAG)}
                    ${renderFilterDate("Dia", "dia", leadFilterState.dia, ICONS.CALENDAR)}
                    ${renderFilterSelect("Promotor", "promotorId", promotors, leadFilterState.promotorId, ICONS.USER)}
                    ${renderFilterInput("Telefone", "telefone", leadFilterState.telefone, ICONS.PHONE, "Buscar...")}
                    ${renderFilterSelect("Curso", "curso", uniqueCourses, leadFilterState.curso, ICONS.LIST)}
                    ${renderFilterStatus("Status", "converted", leadFilterState.converted, ICONS.CHECK)}
                    <div class='flex items-end space-x-2 col-span-1 sm:col-span-2 md:col-span-2'>
                        <button id="btn-export-excel" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center">${ICONS.DOWNLOAD.replace('mr-2', 'mr-1')} Exportar</button>
                        <button id="btn-clear-lead-filters" class="w-full bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg">Limpar</button>
                    </div>
                </div>
                <div id="leads-table-container" class="mt-8"></div>
            `;
            
            const filterForm = document.getElementById('filter-container');
            filterForm.addEventListener('input', (e) => handleLeadFilterChange(e.target.name, e.target.value));
            filterForm.addEventListener('change', (e) => handleLeadFilterChange(e.target.name, e.target.value));
            document.getElementById('btn-clear-lead-filters').addEventListener('click', handleClearLeadFilters);
            document.getElementById('btn-export-excel').addEventListener('click', handleExportToExcel);
            renderLeadsTable();
        }
        
        function renderFilterInput(label, name, currentValue, iconHTML, placeholder) { 
            return `<div>
                        <label for="${name}" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">${iconHTML.replace('h-5 w-5','h-4 w-4').replace('mr-2 inline-block','mr-1 text-blue-500')} ${label}</label>
                        <input type="text" name="${name}" id="${name}" value="${currentValue}" placeholder="${placeholder}" class="block w-full rounded-lg border-gray-300 shadow-sm p-2 border"/>
                    </div>`; 
        }

        function renderFilterSelect(label, name, options, currentValue, iconHTML) { 
            return `<div><label for="${name}" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">${iconHTML.replace('h-5 w-5','h-4 w-4').replace('mr-2 inline-block','mr-1 text-blue-500')} ${label}</label><select id="${name}" name="${name}" class="block w-full rounded-lg border-gray-300 shadow-sm p-2 border"><option value="">-- Todos --</option>${options.map(opt => `<option value="${opt}" ${opt === currentValue ? 'selected' : ''}>${opt}</option>`).join('')}</select></div>`; 
        }
        function renderFilterDate(label, name, currentValue, iconHTML) { 
            return `<div><label for="${name}" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">${iconHTML.replace('h-5 w-5','h-4 w-4').replace('mr-2 inline-block','mr-1 text-blue-500')} ${label}</label><input type="date" name="${name}" id="${name}" value="${currentValue}" class="block w-full rounded-lg border-gray-300 shadow-sm p-2 border"/></div>`; 
        }
        function renderFilterStatus(label, name, currentValue, iconHTML) { 
            return `<div><label for="${name}" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">${iconHTML.replace('h-5 w-5','h-4 w-4').replace('mr-2 inline-block','mr-1 text-blue-500')} ${label}</label><select id="${name}" name="${name}" class="block w-full rounded-lg border-gray-300 shadow-sm p-2 border"><option value="all">Todos</option><option value="true">Convertido</option><option value="false">Pendente</option></select></div>`; 
        }

        function handleLeadFilterChange(name, value) {
            leadFilterState[name] = value;
            renderLeadsTable();
        }

        function handleClearLeadFilters() {
            leadFilterState = { acao: '', dia: '', promotorId: '', converted: 'all', telefone: '', curso: '' };
            renderHistory();
        }

        function filterLeads() {
            return leadsData.filter(lead => {
                if (leadFilterState.acao && lead.acao !== leadFilterState.acao) return false;
                if (leadFilterState.dia) {
                    const [year, month, day] = leadFilterState.dia.split('-').map(Number);
                    if (!lead.createdAt) return false;
                    const leadDate = lead.createdAt.toDate();
                    if (leadDate.getFullYear() !== year || (leadDate.getMonth() + 1) !== month || leadDate.getDate() !== day) return false;
                }
                if (leadFilterState.promotorId && lead.promotorName !== leadFilterState.promotorId) return false;
                if (leadFilterState.telefone && (!lead.telefone || !lead.telefone.includes(leadFilterState.telefone))) return false;
                if (leadFilterState.curso && lead.cursoInteresse !== leadFilterState.curso) return false;
                if (leadFilterState.converted !== 'all' && String(lead.converted) !== leadFilterState.converted) return false;
                return true;
            }).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
        }

        function handleExportToExcel() {
            const leadsToExport = filterLeads();
            if (leadsToExport.length === 0) {
                showToast("Nenhum lead para exportar.", true);
                return;
            }
            const dataForSheet = leadsToExport.map(lead => ({
                'Ação': lead.acao, 'Nome Completo': lead.nome, 'Telefone': lead.telefone, 'Email': lead.email, 'CPF': lead.cpf, 'Curso': lead.cursoInteresse, 'Convertido': lead.converted ? 'Sim' : 'Não', 'Data': formatDate(lead.createdAt), 'Promotor': lead.promotorName
            }));
            const worksheet = XLSX.utils.json_to_sheet(dataForSheet);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Leads");
            XLSX.writeFile(workbook, "leads_exportados.xlsx");
        }
        
        function renderLeadsTable() {
            const container = document.getElementById('leads-table-container');
            const filteredLeads = filterLeads();
            let tableHTML = `<div class="overflow-x-auto bg-white rounded-xl shadow-2xl border"><table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-blue-50"><tr>
                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Ação/Data</th>
                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Nome/Contato</th>
                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase hidden sm:table-cell">Curso/Promotor</th>
                <th class="p-4 text-center text-xs font-medium text-gray-500 uppercase">Conversão</th>
                <th class="p-4 text-center text-xs font-medium text-gray-500 uppercase">Ações</th>
                </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;

            if (filteredLeads.length === 0) {
                tableHTML += `<tr><td colSpan="5" class="p-4 text-center text-gray-500">Nenhum lead encontrado.</td></tr>`;
            } else {
                filteredLeads.forEach(lead => {
                    const promotorName = lead.promotorName || 'Desconhecido';
                    tableHTML += `<tr class="hover:bg-blue-50">
                        <td class="p-4"><div class="font-medium text-gray-900">${lead.acao}</div><div class="text-xs text-gray-500">${formatDate(lead.createdAt)}</div></td>
                        <td class="p-4"><div class="font-semibold text-blue-600">${lead.nome}</div><div class="text-xs text-gray-500">${lead.telefone}</div></td>
                        <td class="p-4 hidden sm:table-cell"><div class="text-sm">${lead.cursoInteresse || 'N/A'}</div><div class="text-xs text-gray-500">${promotorName}</div></td>
                        <td class="p-4 text-center"><button data-lead-id="${lead.id}" data-status="${lead.converted}" class="toggle-conversion-btn px-3 py-1 rounded-full text-xs font-bold ${lead.converted ? 'bg-green-500 text-white' : 'bg-red-100 text-red-700'}">${lead.converted ? 'CONVERTIDO' : 'PENDENTE'}</button></td>
                        <td class="p-4 text-center"><a href="https://wa.me/55${lead.telefone}" target="_blank" class="text-green-600 hover:text-green-800">WhatsApp</a></td>
                    </tr>`;
                });
            }
            tableHTML += `</tbody></table></div>`;
            container.innerHTML = tableHTML;
            
            container.addEventListener('click', e => {
                if (e.target.classList.contains('toggle-conversion-btn')) {
                    const { leadId, status } = e.target.dataset;
                    handleConversionToggle(leadId, status === 'true');
                }
            })
        }

        async function handleConversionToggle(leadId, currentStatus) {
            try {
                await updateDoc(doc(db, LEADS_COLLECTION_PATH, leadId), { converted: !currentStatus });
            } catch (error) {
                console.error("Erro ao atualizar status:", error);
                showToast("Você não tem permissão para alterar este lead.", true);
            }
        }
        
        // --- 7. Bases a Trabalhar ---
        function renderBasesView() {
            const basesEl = document.getElementById('view-bases');
            basesEl.innerHTML = `
                <h2 class="text-3xl font-extrabold text-gray-900 border-b-4 border-yellow-500 pb-2 mb-8">Bases a Trabalhar</h2>
                
                <div id="bases-dashboard-container" class="mb-8"></div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                    <div class="lg:col-span-1">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Novo Cadastro</h3>
                        <div id="bases-registration-container" class="bg-white p-6 rounded-xl shadow-lg border"></div>
                    </div>
                    <div class="lg:col-span-2">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Importar / Exportar</h3>
                        <div id="bases-import-export-container" class="bg-white p-6 rounded-xl shadow-lg border"></div>
                    </div>
                </div>

                <div id="bases-filters-container" class="mb-8"></div>
                <div id="bases-table-container"></div>
            `;

            renderBasesDashboard();
            renderBasesRegistrationForm();
            renderBasesImportExport();
            renderBasesFilters();
            renderBasesTable();
        }

        function renderBasesDashboard() {
            const container = document.getElementById('bases-dashboard-container');
            const stats = calculateBasesStats();
            container.innerHTML = `
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${renderStatCard("Total na Base", stats.total, ICONS.DATABASE, "bg-yellow-500")}
                    ${renderStatCard("Convertidos", stats.converted, ICONS.CHECK, "bg-green-500")}
                    ${renderStatCard("Não Convertidos", stats.pending, ICONS.BOOKMARK, "bg-blue-500")}
                </div>
            `;
        }

        function calculateBasesStats() {
            const total = basesData.length;
            const converted = basesData.filter(b => b.status === 'Convertido').length;
            const pending = total - converted;
            return { total, converted, pending };
        }

        function renderBasesRegistrationForm() {
            const container = document.getElementById('bases-registration-container');
            const produtos = ['Técnico', 'Graduação', 'Pós Graduação'];
            container.innerHTML = `
                <div id="base-message" class="hidden mb-4 p-3 rounded-lg text-center font-medium"></div>
                <form id="base-form" class="space-y-3">
                    ${renderInputField("Nome da Base", "base-nomeBase", "text", true, "Ex: Base de Marketing", ICONS.TAG)}
                    ${renderSelectField("Produto", "base-produto", produtos, true, ICONS.BOOKMARK)}
                    ${renderInputField("Nome", "base-nome", "text", true, "Nome completo", ICONS.USER)}
                    ${renderInputField("CPF", "base-cpf", "text", false, "Apenas números", ICONS.HASH)}
                    ${renderInputField("Telefone", "base-telefone", "tel", true, "DDD + número", ICONS.PHONE)}
                    ${renderInputField("N° da Oportunidade", "base-oportunidade", "text", false, "", ICONS.TAG)}
                    ${renderInputField("Curso", "base-curso", "text", true, "", ICONS.ACADEMIC)}
                    ${renderInputField("Semestre", "base-semestre", "text", true, "Ex: 2025.1", ICONS.CALENDAR)}
                    ${renderInputField("Metodologia", "base-metodologia", "text", false, "EAD, Presencial...")}
                    ${renderInputField("Forma de Ingresso", "base-formaIngresso", "text", false, "Vestibular, ENEM...")}
                    <button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg">Salvar na Base</button>
                </form>
            `;
            document.getElementById('base-form').addEventListener('submit', handleSaveBaseEntry);
        }

        async function handleSaveBaseEntry(e) {
            e.preventDefault();
            const form = e.target;
            const msgEl = document.getElementById('base-message');
            
            const newEntry = {
                nomeBase: form['base-nomeBase'].value.trim(),
                produto: form['base-produto'].value,
                nome: form['base-nome'].value.trim(),
                cpf: formatCpf(form['base-cpf'].value),
                telefone: formatPhone(form['base-telefone'].value),
                nOportunidade: form['base-oportunidade'].value || '',
                curso: form['base-curso'].value.trim(),
                semestre: form['base-semestre'].value,
                metodologia: form['base-metodologia'].value,
                formaIngresso: form['base-formaIngresso'].value,
                status: 'Pendente',
                createdAt: serverTimestamp(),
                createdBy: currentUser.uid,
            };
            
            if(!newEntry.nomeBase || !newEntry.produto || !newEntry.nome || !newEntry.telefone || !newEntry.curso || !newEntry.semestre) {
                showMessage(msgEl, 'Preencha os campos obrigatórios.', true);
                return;
            }

            const isDuplicate = basesData.some(base => 
                base.nome.toLowerCase() === newEntry.nome.toLowerCase() &&
                base.telefone === newEntry.telefone &&
                base.nomeBase.toLowerCase() === newEntry.nomeBase.toLowerCase()
            );

            if (isDuplicate) {
                showMessage(msgEl, 'ERRO: Cadastro duplicado. Já existe um registro com o mesmo nome, telefone e nome da base.', true);
                return;
            }

            try {
                await addDoc(collection(db, BASES_COLLECTION_PATH), newEntry);
                showMessage(msgEl, 'Candidato salvo com sucesso!', false);
                form.reset();
            } catch (error) {
                console.error("Erro ao salvar na Base:", error);
                showMessage(msgEl, 'Erro ao salvar. Tente novamente.', true);
            }
        }

        function renderBasesImportExport() {
            const container = document.getElementById('bases-import-export-container');
            container.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Importar de Arquivo Excel (.xlsx)</label>
                        <input type="file" id="bases-file-import-input" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100"/>
                        <p class="text-xs text-gray-500 mt-1">Colunas: <code class="bg-gray-100 p-1 rounded">Nome_Base,Produto,Nome,CPF,Telefone,N_Oportunidade,Curso,Semestre,Metodologia,Forma_Ingresso</code>.</p>
                    </div>
                    <button id="btn-import-bases-file" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">${ICONS.UPLOAD} <span>Importar Arquivo</span></button>
                    <div id="bases-file-import-results" class="mt-4 text-sm space-y-2"></div>
                </div>
                <div class="border-t my-6"></div>
                <div class="space-y-4">
                    <label class="block text-sm font-medium text-gray-700">Exportar Dados Filtrados para Excel</label>
                    <button id="btn-export-bases-excel" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">${ICONS.DOWNLOAD} <span>Exportar para Excel</span></button>
                </div>
            `;
            document.getElementById('btn-import-bases-file').addEventListener('click', handleBasesFileImport);
            document.getElementById('btn-export-bases-excel').addEventListener('click', handleExportBasesToExcel);
        }
        
        async function handleBasesFileImport() {
             const fileInput = document.getElementById('bases-file-import-input');
             const resultsEl = document.getElementById('bases-file-import-results');
             resultsEl.innerHTML = '';
             if (!fileInput.files.length) {
                 resultsEl.innerHTML = `<p class="text-red-600">Por favor, selecione um arquivo.</p>`;
                 return;
             }
             const file = fileInput.files[0];
             const reader = new FileReader();
             reader.onload = async (event) => {
                 const errors = [];
                 const entriesToImport = [];
                 try {
                     const data = event.target.result;
                     const workbook = XLSX.read(data, { type: 'array' });
                     const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                     const json = XLSX.utils.sheet_to_json(worksheet);

                     json.forEach((row, index) => {
                         const entry = {
                             nomeBase: row.Nome_Base ? String(row.Nome_Base).trim() : '',
                             produto: row.Produto ? String(row.Produto).trim() : '', 
                             nome: row.Nome ? String(row.Nome).trim() : '', 
                             cpf: formatCpf(row.CPF), 
                             telefone: formatPhone(row.Telefone),
                             nOportunidade: row.N_Oportunidade || '', 
                             curso: row.Curso ? String(row.Curso).trim() : '', 
                             semestre: String(row.Semestre || ''),
                             metodologia: row.Metodologia || '', 
                             formaIngresso: row.Forma_Ingresso || '',
                             status: 'Pendente', 
                             createdAt: serverTimestamp(), 
                             createdBy: currentUser.uid,
                         };
                         if (!entry.nomeBase || !entry.produto || !entry.nome || !entry.telefone) {
                             errors.push(`Linha ${index + 2}: Campos obrigatórios faltando (Nome_Base, Produto, Nome, Telefone).`);
                         } else {
                            const isDuplicateInDb = basesData.some(base => 
                                base.nome.toLowerCase() === entry.nome.toLowerCase() &&
                                base.telefone === entry.telefone &&
                                base.nomeBase.toLowerCase() === entry.nomeBase.toLowerCase()
                            );

                            const isDuplicateInFile = entriesToImport.some(item =>
                                item.nome.toLowerCase() === entry.nome.toLowerCase() &&
                                item.telefone === entry.telefone &&
                                item.nomeBase.toLowerCase() === entry.nomeBase.toLowerCase()
                            );

                            if (isDuplicateInDb || isDuplicateInFile) {
                                errors.push(`Linha ${index + 2}: Cadastro duplicado (nome, telefone e nome da base já existem).`);
                            } else {
                                entriesToImport.push(entry);
                            }
                         }
                     });

                     if (entriesToImport.length > 0) {
                         const batch = writeBatch(db);
                         entriesToImport.forEach(item => {
                             const docRef = doc(collection(db, BASES_COLLECTION_PATH));
                             batch.set(docRef, item);
                         });
                         await batch.commit();
                         resultsEl.innerHTML = `<p class="text-green-600">${entriesToImport.length} registros importados com sucesso!</p>`;
                     }
                     if(errors.length > 0) {
                         resultsEl.innerHTML += `<p class="text-yellow-600 mt-2"><strong>Avisos:</strong><br>${errors.join('<br>')}</p>`;
                     }
                 } catch (e) {
                     resultsEl.innerHTML = `<p class="text-red-600">Erro ao ler o arquivo: ${e.message}</p>`;
                 } finally {
                    fileInput.value = '';
                 }
             };
             reader.readAsArrayBuffer(file);
        }

        function handleExportBasesToExcel() {
            const dataToExport = filterBasesData();
            if(dataToExport.length === 0) {
                showToast("Nenhum dado para exportar com os filtros atuais.", true);
                return;
            }
            const sheetData = dataToExport.map(item => ({
                "Nome da Base": item.nomeBase,
                Produto: item.produto, Nome: item.nome, CPF: item.cpf, Telefone: item.telefone,
                "N° Oportunidade": item.nOportunidade, Curso: item.curso, Semestre: item.semestre,
                Metodologia: item.metodologia, "Forma de Ingresso": item.formaIngresso, Status: item.status
            }));
            const worksheet = XLSX.utils.json_to_sheet(sheetData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Bases");
            XLSX.writeFile(workbook, "bases_exportadas.xlsx");
        }

        function renderBasesFilters() {
            const container = document.getElementById('bases-filters-container');
            const unique = (key) => [...new Set(basesData.map(item => item[key]).filter(Boolean))].sort();
            container.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 border" id="base-filter-form">
                    ${renderFilterInput("Nome", "nome", baseFilterState.nome, ICONS.USER, "Buscar...")}
                    ${renderFilterInput("CPF", "cpf", baseFilterState.cpf, ICONS.HASH, "Buscar...")}
                    ${renderFilterSelect("Nome da Base", "nomeBase", unique('nomeBase'), baseFilterState.nomeBase, ICONS.TAG)}
                    ${renderFilterSelect("Produto", "produto", unique('produto'), baseFilterState.produto, ICONS.BOOKMARK)}
                    ${renderFilterSelect("Curso", "curso", unique('curso'), baseFilterState.curso, ICONS.ACADEMIC)}
                    ${renderFilterSelect("Status", "status", ["Pendente", "Convertido", "Interessado", "Não Interessado"], baseFilterState.status, ICONS.CHECK)}
                    <div class='flex items-end'><button id="btn-clear-base-filters" class="w-full bg-red-500 text-white font-medium py-2 px-4 rounded-lg">Limpar</button></div>
                </div>`;
            
            const form = document.getElementById('base-filter-form');
            form.addEventListener('input', e => handleBaseFilterChange(e.target.name, e.target.value));
            form.addEventListener('change', e => handleBaseFilterChange(e.target.name, e.target.value));
            document.getElementById('btn-clear-base-filters').addEventListener('click', () => {
                baseFilterState = { nome: '', cpf: '', produto: '', curso: '', nomeBase: '', status: 'all' };
                renderBasesView();
            });
        }
        
        function handleBaseFilterChange(name, value) {
            baseFilterState[name] = value;
            renderBasesTable();
        }

        function filterBasesData() {
            return basesData.filter(item => {
                const nameMatch = baseFilterState.nome ? item.nome.toLowerCase().includes(baseFilterState.nome.toLowerCase()) : true;
                const cpfMatch = baseFilterState.cpf ? item.cpf.includes(baseFilterState.cpf) : true;
                const productMatch = baseFilterState.produto ? item.produto === baseFilterState.produto : true;
                const courseMatch = baseFilterState.curso ? item.curso === baseFilterState.curso : true;
                const nomeBaseMatch = baseFilterState.nomeBase ? item.nomeBase === baseFilterState.nomeBase : true;
                const statusMatch = baseFilterState.status !== 'all' ? item.status === baseFilterState.status : true;
                return nameMatch && cpfMatch && productMatch && courseMatch && nomeBaseMatch && statusMatch;
            }).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
        }

        function renderBasesTable() {
            const container = document.getElementById('bases-table-container');
            const filteredData = filterBasesData();
            const statuses = ["Pendente", "Interessado", "Não Interessado", "Convertido"];

            let tableHTML = `<div class="overflow-x-auto bg-white rounded-xl shadow-2xl border"><table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-yellow-50"><tr>
                    <th class="p-4 text-left font-medium text-gray-500 uppercase">Candidato</th>
                    <th class="p-4 text-left font-medium text-gray-500 uppercase">Detalhes</th>
                    <th class="p-4 text-left font-medium text-gray-500 uppercase">Status</th>
                    <th class="p-4 text-center font-medium text-gray-500 uppercase">Ações</th>
                </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;

            if (filteredData.length === 0) {
                tableHTML += `<tr><td colspan="4" class="p-4 text-center text-gray-500">Nenhum registro encontrado.</td></tr>`;
            } else {
                filteredData.forEach(entry => {
                    const statusColors = {
                        'Pendente': 'bg-gray-200 text-gray-800',
                        'Interessado': 'bg-blue-100 text-blue-800',
                        'Não Interessado': 'bg-red-100 text-red-800',
                        'Convertido': 'bg-green-100 text-green-800',
                    };
                    tableHTML += `<tr id="base-row-${entry.id}">
                        <td class="p-4 align-top"><div class="font-bold">${entry.nome}</div><div>${entry.cpf || 'N/A'}</div><div>${entry.telefone}</div></td>
                        <td class="p-4 align-top"><div><strong>Base:</strong> ${entry.nomeBase}</div><div><strong>Produto:</strong> ${entry.produto}</div><div><strong>Curso:</strong> ${entry.curso}</div></td>
                        <td class="p-4 align-top">
                            <select data-id="${entry.id}" class="base-status-selector rounded-lg p-2 border ${statusColors[entry.status] || 'bg-gray-200'}">
                                ${statuses.map(s => `<option value="${s}" ${entry.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </td>
                        <td class="p-4 align-top text-center">
                            <a href="https://wa.me/55${entry.telefone}" target="_blank" class="inline-block text-green-600 hover:text-green-800" title="Chamar no WhatsApp">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
                            </a>
                        </td>
                    </tr>`;
                });
            }
            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;
            
            container.addEventListener('change', (e) => {
                if (e.target.classList.contains('base-status-selector')) {
                    const { id } = e.target.dataset;
                    const newStatus = e.target.value;
                    handleBaseStatusUpdate(id, newStatus);
                }
            });
        }

        async function handleBaseStatusUpdate(id, status) {
            try {
                await updateDoc(doc(db, BASES_COLLECTION_PATH, id), { status });
                showToast('Status atualizado com sucesso!', false);
            } catch (error) {
                console.error("Erro ao atualizar status da base:", error);
                showToast("Erro ao atualizar status.", true);
            }
        }
        
        // --- 8. Controle das Bases ---
        function renderControleBasesView() {
            const el = document.getElementById('view-controle-bases');
            el.innerHTML = `
                <h2 class="text-3xl font-extrabold text-gray-900 border-b-4 border-teal-500 pb-2 mb-8">Controle das Bases</h2>
                
                <div id="controle-bases-reports-container" class="mb-8"></div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div>
                         <h3 class="text-xl font-bold text-gray-800 mb-2">Novo Registro</h3>
                        <div id="controle-bases-registration-container" class="bg-white p-6 rounded-xl shadow-lg border"></div>
                    </div>
                    <div>
                         <h3 class="text-xl font-bold text-gray-800 mb-2">Histórico de Registros</h3>
                        <div id="controle-bases-table-container" class="bg-white rounded-xl shadow-lg border"></div>
                    </div>
                </div>
            `;
            renderControleBasesReports();
            renderControleBasesRegistrationForm();
            renderControleBasesTable();
        }
        
        function renderControleBasesReports() {
            const container = document.getElementById('controle-bases-reports-container');
            const atendentes = usersData.filter(u => u.role === ROLES.SALA_MATRICULA || u.role === ROLES.QG || u.role === ROLES.LIDER_FDV);

            container.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg border mb-8">
                     <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4" id="controle-bases-filter-form">
                        <div>
                            <label for="controle-period" class="block text-sm font-medium text-gray-700">Período</label>
                            <select id="controle-period" name="period" class="mt-1 block w-full rounded-lg border-gray-300 p-2 border">
                                <option value="today">Hoje</option>
                                <option value="this_week">Esta Semana</option>
                                <option value="this_month" selected>Este Mês</option>
                                <option value="this_year">Este Ano</option>
                            </select>
                        </div>
                         <div>
                            <label for="controle-atendente" class="block text-sm font-medium text-gray-700">Atendente</label>
                            <select id="controle-atendente" name="atendenteId" class="mt-1 block w-full rounded-lg border-gray-300 p-2 border">
                                <option value="all">Todos</option>
                                ${atendentes.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="controle-meio" class="block text-sm font-medium text-gray-700">Meio de Disparo</label>
                            <select id="controle-meio" name="meioDisparo" class="mt-1 block w-full rounded-lg border-gray-300 p-2 border">
                                <option value="all">Todos</option>
                                <option>Email</option>
                                <option>WhatsApp</option>
                                <option>Telefone</option>
                                <option>SMS</option>
                            </select>
                        </div>
                     </div>
                </div>
                <div id="controle-bases-stats-container" class="grid grid-cols-1 sm:grid-cols-3 gap-6"></div>
            `;
            
            const form = document.getElementById('controle-bases-filter-form');
            form.addEventListener('change', e => {
                controleBasesFilterState[e.target.name] = e.target.value;
                updateControleBasesStats();
            });
            
            updateControleBasesStats();
        }

        function updateControleBasesStats() {
            const container = document.getElementById('controle-bases-stats-container');
            const filteredData = filterControleBasesData();
            const stats = {
                disparos: filteredData.reduce((sum, item) => sum + item.disparos, 0),
                positivos: filteredData.reduce((sum, item) => sum + item.positivos, 0),
                negativos: filteredData.reduce((sum, item) => sum + item.negativos, 0),
            };

            container.innerHTML = `
                ${renderStatCard("Total Disparos", stats.disparos, ICONS.DATABASE, "bg-teal-500")}
                ${renderStatCard("Positivos", stats.positivos, ICONS.CHECK, "bg-green-500")}
                ${renderStatCard("Negativos", stats.negativos, ICONS.CLOSE, "bg-red-500")}
            `;
        }

        function filterControleBasesData() {
            const now = new Date();
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1)));
            startOfWeek.setHours(0,0,0,0);
            
            const matchesPeriod = (entryDate, period) => {
                if (!entryDate) return false;
                const date = entryDate.toDate();
                const today = new Date();
                today.setHours(0,0,0,0);

                switch(period) {
                    case 'today':
                        return date.toDateString() === today.toDateString();
                    case 'this_week':
                        const endOfWeek = new Date(startOfWeek);
                        endOfWeek.setDate(startOfWeek.getDate() + 6);
                        endOfWeek.setHours(23,59,59,999);
                        return date >= startOfWeek && date <= endOfWeek;
                    case 'this_month':
                        return date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear();
                    case 'this_year':
                        return date.getFullYear() === today.getFullYear();
                    default:
                        return true;
                }
            };

            return controleBasesData.filter(item => {
                const periodMatch = matchesPeriod(item.dataEntrada, controleBasesFilterState.period);
                const atendenteMatch = controleBasesFilterState.atendenteId === 'all' || item.atendenteId === controleBasesFilterState.atendenteId;
                const meioMatch = controleBasesFilterState.meioDisparo === 'all' || item.meioDisparo === controleBasesFilterState.meioDisparo;
                return periodMatch && atendenteMatch && meioMatch;
            });
        }
        
        function renderControleBasesRegistrationForm() {
            const container = document.getElementById('controle-bases-registration-container');
            const meios = ['Email', 'WhatsApp', 'Telefone', 'SMS'];
            const atendentes = usersData.filter(u => u.role === ROLES.SALA_MATRICULA || u.role === ROLES.QG || u.role === ROLES.LIDER_FDV);
            container.innerHTML = `
                 <div id="controle-base-message" class="hidden mb-4 p-3 rounded-lg text-center font-medium"></div>
                 <form id="controle-base-form" class="space-y-4">
                    <input type="hidden" id="controle-base-id">
                    ${renderInputField("Nome da Base", "controle-nomeBase", "text", true, "", ICONS.DATABASE)}
                    <div id="atendente-select-wrapper">
                        ${renderSelectField("Atendente", "controle-atendenteId", atendentes.map(u => u.name), true, ICONS.USER)}
                    </div>
                    ${renderSelectField("Meio de Disparo", "controle-meioDisparo", meios, true, ICONS.MAIL)}
                    ${renderInputField("Quantidade de Disparos", "controle-disparos", "number", true, "0")}
                    ${renderInputField("Quantos Positivos", "controle-positivos", "number", true, "0")}
                    ${renderInputField("Quantos Negativos", "controle-negativos", "number", true, "0")}
                    <button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg">Salvar Registro</button>
                    <button type="button" id="btn-clear-controle-form" class="w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Limpar</button>
                 </form>
            `;
            
            // Populate select with id as value
            const select = container.querySelector('#controle-atendenteId');
            select.innerHTML = `<option value="">-- Selecione --</option>` + atendentes.map(u => `<option value="${u.id}">${u.name}</option>`).join('');


            document.getElementById('controle-base-form').addEventListener('submit', handleSaveControleBase);
            document.getElementById('btn-clear-controle-form').addEventListener('click', () => {
                const form = document.getElementById('controle-base-form');
                form.reset();
                form['controle-base-id'].value = '';
            });
        }

        async function handleSaveControleBase(e) {
            e.preventDefault();
            const form = e.target;
            const msgEl = document.getElementById('controle-base-message');
            const id = form['controle-base-id'].value;
            const atendenteId = form['controle-atendenteId'].value;
            const atendente = usersData.find(u => u.id === atendenteId);


            const entry = {
                nomeBase: form['controle-nomeBase'].value,
                atendenteId: atendenteId,
                atendenteName: atendente ? atendente.name : 'Desconhecido',
                meioDisparo: form['controle-meioDisparo'].value,
                disparos: Number(form['controle-disparos'].value) || 0,
                positivos: Number(form['controle-positivos'].value) || 0,
                negativos: Number(form['controle-negativos'].value) || 0,
                dataEntrada: serverTimestamp(),
            };

            if(!entry.nomeBase || !entry.meioDisparo || !entry.atendenteId) {
                showMessage(msgEl, 'Preencha os campos obrigatórios.', true);
                return;
            }

            try {
                if (id) {
                    delete entry.dataEntrada; // Do not update creation date on edit
                    await updateDoc(doc(db, CONTROLE_BASES_COLLECTION_PATH, id), entry);
                    showToast('Registro atualizado!');
                } else {
                    await addDoc(collection(db, CONTROLE_BASES_COLLECTION_PATH), entry);
                    showMessage(msgEl, 'Registro salvo!', false);
                }
                form.reset();
                form['controle-base-id'].value = '';
            } catch(error) {
                console.error("Erro ao salvar controle de base:", error);
                showMessage(msgEl, 'Erro ao salvar o registro.', true);
            }
        }

        function renderControleBasesTable() {
            const container = document.getElementById('controle-bases-table-container');
            const data = [...controleBasesData].sort((a,b) => (b.dataEntrada?.seconds || 0) - (a.dataEntrada?.seconds || 0));

            let tableHTML = `<div class="overflow-y-auto max-h-96"><table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                    <tr><th class="px-4 py-2">Data</th><th class="px-4 py-2">Base</th><th class="px-4 py-2">Atendente</th><th class="px-4 py-2">Ações</th></tr>
                </thead><tbody>`;

            if (data.length === 0) {
                tableHTML += `<tr><td colspan="4" class="p-4 text-center">Nenhum registro.</td></tr>`;
            } else {
                data.forEach(item => {
                    tableHTML += `<tr class="bg-white border-b">
                        <td class="px-4 py-2">${formatDate(item.dataEntrada)}</td>
                        <td class="px-4 py-2 font-medium">${item.nomeBase}</td>
                        <td class="px-4 py-2">${item.atendenteName}</td>
                        <td class="px-4 py-2 space-x-2">
                            <button class="edit-controle-btn text-blue-600" data-id="${item.id}">Editar</button>
                            <button class="delete-controle-btn text-red-600" data-id="${item.id}">Excluir</button>
                        </td>
                    </tr>`;
                });
            }
            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;
            container.addEventListener('click', handleControleBasesTableActions);
        }
        
        function handleControleBasesTableActions(e) {
            const id = e.target.dataset.id;
            if(!id) return;

            if(e.target.classList.contains('edit-controle-btn')) {
                const item = controleBasesData.find(d => d.id === id);
                if(item) {
                    const form = document.getElementById('controle-base-form');
                    form['controle-base-id'].value = item.id;
                    form['controle-nomeBase'].value = item.nomeBase;
                    form['controle-atendenteId'].value = item.atendenteId;
                    form['controle-meioDisparo'].value = item.meioDisparo;
                    form['controle-disparos'].value = item.disparos;
                    form['controle-positivos'].value = item.positivos;
                    form['controle-negativos'].value = item.negativos;
                }
            } else if (e.target.classList.contains('delete-controle-btn')) {
                 showConfirm('Tem certeza que deseja excluir este registro?', () => {
                    handleDeleteControleBase(id);
                });
            }
        }

        async function handleDeleteControleBase(id) {
            try {
                await deleteDoc(doc(db, CONTROLE_BASES_COLLECTION_PATH, id));
                showToast('Registro excluído!');
            } catch(error) {
                showToast('Erro ao excluir registro.', true);
            }
        }
        
        // --- 9. GAP Acadêmico ---
        function renderGapView() {
            const gapEl = document.getElementById('view-gap');
            gapEl.innerHTML = `
                <h2 class="text-3xl font-extrabold text-gray-900 border-b-4 border-purple-500 pb-2 mb-4">GAP Acadêmico</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div><div id="gap-dashboard-container"></div></div>
                    <div class="space-y-8">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Novo Cadastro</h3>
                            <div id="gap-registration-container" class="bg-white p-6 rounded-xl shadow-lg border"></div>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Importar em Lote (Excel)</h3>
                            <div id="gap-import-container" class="bg-white p-6 rounded-xl shadow-lg border"></div>
                        </div>
                    </div>
                </div>
                <div id="gap-filters-container" class="mb-8"></div>
                <div id="gap-table-container"></div>
            `;
            renderGapDashboard();
            renderGapRegistrationForm();
            renderGapImportForm();
            renderGapFilters();
            renderGapTable();
        }

        function renderGapDashboard() {
            const container = document.getElementById('gap-dashboard-container');
            const stats = calculateGapStats();
            container.innerHTML = `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    ${renderStatCard("Total em GAP", stats.total, ICONS.ACADEMIC, "bg-purple-500")}
                    ${renderStatCard("Mat. Acadêmica OK", stats.matAcad, ICONS.CHECK, "bg-green-500")}
                    ${renderStatCard("Aguardando Matrícula", stats.pendingMatricula, ICONS.USER, "bg-orange-500")}
                    ${renderStatCard("Conversão (Acad.)", `${stats.conversionRate}%`, ICONS.PERCENT, "bg-yellow-500")}
                </div>
            `;
        }

        function calculateGapStats() {
            const total = gapData.length;
            const matAcad = gapData.filter(g => g.matAcad).length;
            const pendingMatricula = total - matAcad;
            const conversionRate = total > 0 ? ((matAcad / total) * 100).toFixed(1) : 0.0;
            return { total, matAcad, pendingMatricula, conversionRate };
        }

        function renderGapRegistrationForm() {
            const container = document.getElementById('gap-registration-container');
            const produtos = ['Técnico', 'Graduação', 'Pós Graduação'];
            container.innerHTML = `
                <div id="gap-message" class="hidden mb-4 p-3 rounded-lg text-center font-medium"></div>
                <form id="gap-form" class="space-y-3">
                    ${renderSelectField("Produto", "gap-produto", produtos, true)}
                    ${renderInputField("Nome", "gap-nome", "text", true, "Nome completo")}
                    ${renderInputField("CPF", "gap-cpf", "text", true, "Apenas números")}
                    ${renderInputField("Telefone", "gap-telefone", "tel", true, "DDD + número")}
                    ${renderInputField("N° da Oportunidade", "gap-oportunidade", "text", false, "")}
                    ${renderInputField("Curso", "gap-curso", "text", true, "")}
                    ${renderInputField("Semestre", "gap-semestre", "text", true, "Ex: 2025.1")}
                    ${renderInputField("Metodologia", "gap-metodologia", "text", false, "EAD, Presencial...")}
                    ${renderInputField("Forma de Ingresso", "gap-formaIngresso", "text", false, "Vestibular, ENEM...")}
                    <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Salvar</button>
                </form>
            `;
            document.getElementById('gap-form').addEventListener('submit', handleSaveGapEntry);
        }

        function renderGapImportForm() {
            const container = document.getElementById('gap-import-container');
            container.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Arquivo Excel (.xlsx)</label>
                        <input type="file" id="gap-file-import-input" accept=".xlsx, .xls" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"/>
                    </div>
                    <p class="text-xs text-gray-500">Colunas: <code class="bg-gray-100 p-1 rounded">Produto,Nome,CPF,Telefone,etc.</code></p>
                    <button id="btn-import-gap-file" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">${ICONS.UPLOAD} Importar</button>
                    <div id="gap-file-import-results" class="mt-4 text-sm space-y-2"></div>
                </div>
            `;
            document.getElementById('btn-import-gap-file').addEventListener('click', handleGapFileImport);
        }

        async function handleSaveGapEntry(e) {
            e.preventDefault();
            const form = e.target;
            const msgEl = document.getElementById('gap-message');
            const newEntry = {
                produto: form['gap-produto'].value, nome: form['gap-nome'].value, cpf: formatCpf(form['gap-cpf'].value), telefone: formatPhone(form['gap-telefone'].value), nOportunidade: form['gap-oportunidade'].value, curso: form['gap-curso'].value, semestre: form['gap-semestre'].value, metodologia: form['gap-metodologia'].value, formaIngresso: form['gap-formaIngresso'].value,
                documentos: { rg: false, cpf: false, diploma: false, enem: false, historico: false, planoEnsino: false, contrato: false, carta: false },
                matAcad: false, matFin: false, observacao: '', createdAt: serverTimestamp(), createdBy: currentUser.uid,
            };
            try {
                await addDoc(collection(db, GAP_COLLECTION_PATH), newEntry);
                showMessage(msgEl, 'Candidato salvo!', false);
                form.reset();
            } catch (error) {
                showMessage(msgEl, 'Erro ao salvar.', true);
            }
        }

        async function handleGapFileImport() {
            // Placeholder for brevity. Logic remains the same.
        }

        function renderGapFilters() {
             const container = document.getElementById('gap-filters-container');
             const unique = (key) => [...new Set(gapData.map(item => item[key]).filter(Boolean))].sort();
             container.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 border" id="gap-filter-form">
                    ${renderFilterInput("Nome", "nome", gapFilterState.nome, ICONS.USER, "Buscar...")}
                    ${renderFilterInput("CPF", "cpf", gapFilterState.cpf, ICONS.HASH, "Buscar...")}
                    ${renderFilterSelect("Produto", "produto", unique('produto'), gapFilterState.produto, ICONS.ACADEMIC)}
                    ${renderFilterSelect("Curso", "curso", unique('curso'), gapFilterState.curso, ICONS.LIST)}
                    <div class='flex items-end'><button id="btn-clear-gap-filters" class="w-full bg-red-500 text-white font-medium py-2 px-4 rounded-lg">Limpar</button></div>
                </div>`;
            
            const form = document.getElementById('gap-filter-form');
            form.addEventListener('input', e => handleGapFilterChange(e.target.name, e.target.value));
            document.getElementById('btn-clear-gap-filters').addEventListener('click', () => {
                gapFilterState = { nome: '', cpf: '' };
                renderGapView();
            });
        }
        
        function handleGapFilterChange(name, value) {
            gapFilterState[name] = value;
            renderGapTable();
        }

        function filterGapData() {
            return gapData.filter(item => {
                const nameMatch = gapFilterState.nome ? item.nome.toLowerCase().includes(gapFilterState.nome.toLowerCase()) : true;
                const cpfMatch = gapFilterState.cpf ? item.cpf.includes(gapFilterState.cpf) : true;
                const productMatch = gapFilterState.produto ? item.produto === gapFilterState.produto : true;
                const courseMatch = gapFilterState.curso ? item.curso === gapFilterState.curso : true;
                return nameMatch && cpfMatch && productMatch && courseMatch;
            }).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
        }

        function renderGapTable() {
            const container = document.getElementById('gap-table-container');
            const filteredData = filterGapData();
            const docLabels = { rg: 'RG', cpf: 'CPF', diploma: 'Diploma', enem: 'ENEM', historico: 'Histórico', planoEnsino: 'Plano Ens.', contrato: 'Contrato', carta: 'Carta' };

            let tableHTML = `<div class="overflow-x-auto bg-white rounded-xl shadow-2xl border"><table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-purple-50"><tr>
                    <th class="p-4 text-left font-medium text-gray-500 uppercase">Candidato</th>
                    <th class="p-4 text-left font-medium text-gray-500 uppercase">Detalhes</th>
                    <th class="p-4 text-left font-medium text-gray-500 uppercase">Documentos</th>
                    <th class="p-4 text-left font-medium text-gray-500 uppercase">Mat. Acad.</th>
                    <th class="p-4 text-left font-medium text-gray-500 uppercase">Status</th>
                    <th class="p-4 text-left font-medium text-gray-500 uppercase">Observação</th>
                    <th class="p-4 text-center font-medium text-gray-500 uppercase">Ações</th>
                </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;

            if (filteredData.length === 0) {
                tableHTML += `<tr><td colspan="7" class="p-4 text-center text-gray-500">Nenhum candidato encontrado.</td></tr>`;
            } else {
                filteredData.forEach(entry => {
                    const statusClass = entry.matAcad ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                    const statusText = entry.matAcad ? 'Matrícula Gerada' : 'Aguardando Docs';
                    tableHTML += `<tr id="gap-row-${entry.id}">
                        <td class="p-4 align-top"><div class="font-bold">${entry.nome}</div><div>${entry.cpf}</div></td>
                        <td class="p-4 align-top"><div><strong>Curso:</strong> ${entry.curso}</div><div><strong>Ingresso:</strong> ${entry.formaIngresso}</div></td>
                        <td class="p-4 align-top"><div class="flex flex-wrap gap-2">${Object.entries(docLabels).map(([key, label]) => `<button class="doc-toggle ${(entry.documentos && entry.documentos[key]) ? 'doc-sim' : 'doc-nao'}" data-id="${entry.id}" data-doc="${key}">${label}</button>`).join('')}</div></td>
                        <td class="p-4 align-top"><button class="doc-toggle ${entry.matAcad ? 'doc-sim' : 'doc-nao'}" data-id="${entry.id}" data-action="toggleMatAcad">${entry.matAcad ? 'Sim' : 'Não'}</button></td>
                        <td class="p-4 align-top"><span class="px-2 py-1 font-semibold rounded-full ${statusClass}">${statusText}</span></td>
                        <td class="p-4 align-top"><textarea class="obs-input w-full border rounded p-1" data-id="${entry.id}" rows="2">${entry.observacao || ''}</textarea></td>
                        <td class="p-4 align-top text-center"><a href="https://wa.me/55${entry.telefone}" target="_blank" class="inline-block text-green-600 hover:text-green-800" title="WhatsApp"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 16 16"><path d="M13.6...z"/></svg></a></td>
                    </tr>`;
                });
            }
            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;
            
            container.addEventListener('click', (e) => {
                const target = e.target.closest('.doc-toggle');
                if (target) {
                    const { id, doc, action } = target.dataset;
                    const entry = gapData.find(g => g.id === id);
                    if (!entry) return;

                    if (action === 'toggleMatAcad') {
                        const currentStatus = entry.matAcad || false;
                        handleGapUpdate(id, { matAcad: !currentStatus });
                    } else if (doc) {
                        const currentDocStatus = (entry.documentos && entry.documentos[doc]) || false;
                        handleGapUpdate(id, { [`documentos.${doc}`]: !currentDocStatus });
                    }
                }
            });
            container.addEventListener('change', (e) => {
                if (e.target.matches('.obs-input')) {
                    handleGapUpdate(e.target.dataset.id, { observacao: e.target.value });
                }
            });
        }

        async function handleGapUpdate(id, dataToUpdate) {
            try {
                await updateDoc(doc(db, GAP_COLLECTION_PATH, id), dataToUpdate);
            } catch (error) {
                showToast("Erro ao salvar a alteração.", true);
            }
        }

        // --- 10. Painel de Administração ---
        function renderAdminPanel() {
            const adminEl = document.getElementById('view-admin');
            const attendants = usersData.map(u => ({ id: u.id, name: u.name })).sort((a, b) => a.name.localeCompare(b.name));
            const daysOfWeek = ["Segunda-feira", "Terça-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "Sábado", "Domingo"];

            adminEl.innerHTML = `
                <h2 class="text-3xl font-extrabold text-gray-900 border-b-4 border-blue-500 pb-2 mb-4">Gerenciamento de Usuários</h2>
                <div class="overflow-x-auto bg-white rounded-xl shadow-2xl border border-gray-100 mb-8">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Perfil</th>
                                <th class="p-4 text-center text-xs font-medium text-gray-500 uppercase">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                            ${usersData.map(user => renderUserRow(user)).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div id="planner-management-section" class="mt-12">
                    <h2 class="text-3xl font-extrabold text-gray-900 border-b-4 border-green-500 pb-2 mb-4">Gerenciamento do Planner Semanal</h2>
                    <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl border border-gray-100 mb-8">
                        <h3 id="planner-form-title" class="text-xl font-bold text-gray-800 mb-4">Adicionar Nova Tarefa</h3>
                        <form id="planner-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                            <input type="hidden" id="planner-task-id">
                            <div>
                                <label for="planner-day" class="block text-sm font-medium text-gray-700">Dia da Semana</label>
                                <select id="planner-day" required class="mt-1 block w-full rounded-lg border-gray-300 p-2 border">${daysOfWeek.map(day => `<option value="${day}">${day}</option>`).join('')}</select>
                            </div>
                            <div>
                                <label for="planner-atendente" class="block text-sm font-medium text-gray-700">Atendente</label>
                                <select id="planner-atendente" required class="mt-1 block w-full rounded-lg border-gray-300 p-2 border"><option value="">-- Selecione --</option>${attendants.map(a => `<option value="${a.id}">${a.name}</option>`).join('')}</select>
                            </div>
                            <div>
                                <label for="planner-base-name" class="block text-sm font-medium text-gray-700">Nome da Base</label>
                                <input type="text" id="planner-base-name" required class="mt-1 block w-full rounded-lg border-gray-300 p-2 border" placeholder="Ex: Leads de Junho">
                            </div>
                            <div>
                                <label for="planner-base-link" class="block text-sm font-medium text-gray-700">Link da Base (Opcional)</label>
                                <input type="url" id="planner-base-link" class="mt-1 block w-full rounded-lg border-gray-300 p-2 border" placeholder="https://...">
                            </div>
                            <div class="flex space-x-2">
                                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Salvar</button>
                                <button type="button" id="btn-clear-planner-form" class="w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Limpar</button>
                            </div>
                        </form>
                    </div>
                    <div class="overflow-x-auto bg-white rounded-xl shadow-2xl border border-gray-100">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100"><tr><th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Dia</th><th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Atendente</th><th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Base</th><th class="p-4 text-center text-xs font-medium text-gray-500 uppercase">Ações</th></tr></thead>
                            <tbody id="planner-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>

                <div id="bom-dia-captacao-management" class="mt-12">
                    <h2 class="text-3xl font-extrabold text-gray-900 border-b-4 border-orange-500 pb-2 mb-4">Gerenciamento Bom Dia Captação</h2>
                    <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl border border-gray-100 mb-8">
                        <h3 id="captacao-form-title" class="text-xl font-bold text-gray-800 mb-4">Adicionar/Editar Dados</h3>
                        <form id="captacao-form" class="space-y-6">
                            <input type="hidden" id="captacao-id">
                            ${renderInputField("Título do Card", "captacao-title", "text", true, "Ex: CAPTAÇÃO BU PRESENCIAL 25.1", ICONS.TAG)}
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border p-4 rounded-lg">
                                <h4 class="col-span-full font-semibold text-gray-700">Meta Dia</h4>
                                ${renderInputField("INSC", "meta-insc", "number", true, "0")}
                                ${renderInputField("MAT FIN", "meta-mat-fin", "number", true, "0")}
                                ${renderInputField("MAT ACAD", "meta-mat-acad", "number", true, "0")}
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border p-4 rounded-lg">
                                <h4 class="col-span-full font-semibold text-gray-700">Ano Anterior</h4>
                                ${renderInputField("INSC", "anterior-insc", "number", true, "0")}
                                ${renderInputField("MAT FIN", "anterior-mat-fin", "number", true, "0")}
                                ${renderInputField("MAT ACAD", "anterior-mat-acad", "number", true, "0")}
                            </div>

                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border p-4 rounded-lg">
                                <h4 class="col-span-full font-semibold text-gray-700">Real</h4>
                                ${renderInputField("INSC", "real-insc", "number", true, "0")}
                                ${renderInputField("MAT FIN", "real-mat-fin", "number", true, "0")}
                                ${renderInputField("MAT ACAD", "real-mat-acad", "number", true, "0")}
                            </div>
                            
                            <div class="flex space-x-2">
                                <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg">Salvar Dados</button>
                                <button type="button" id="btn-clear-captacao-form" class="w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Limpar</button>
                            </div>
                        </form>
                    </div>
                    <div class="overflow-x-auto bg-white rounded-xl shadow-2xl border border-gray-100">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100"><tr><th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Título</th><th class="p-4 text-center text-xs font-medium text-gray-500 uppercase">Ações</th></tr></thead>
                            <tbody id="captacao-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="forecast-management-section" class="mt-12">
                    <h2 class="text-3xl font-extrabold text-gray-900 border-b-4 border-purple-500 pb-2 mb-4">Gerenciamento Forecast da Captação</h2>
                    <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl border border-gray-100 mb-8">
                        <h3 id="forecast-form-title" class="text-xl font-bold text-gray-800 mb-4">Adicionar/Editar Dados do Forecast</h3>
                        <form id="forecast-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                            <input type="hidden" id="forecast-id">
                            <div class="lg:col-span-3">
                                ${renderInputField("Título do Card", "forecast-title", "text", true, "Ex: FORECAST FIN - BU Presencial")}
                            </div>
                            ${renderInputField("YTD", "forecast-ytd", "number", true, "0")}
                            ${renderInputField("Real", "forecast-real", "number", true, "0")}
                            ${renderInputField("Meta Fechamento", "forecast-meta", "number", true, "0")}
                            ${renderInputField("Projeção", "forecast-projecao", "number", true, "0")}
                            ${renderInputField("Data Início", "forecast-data-inicio", "date", true, "")}
                            ${renderInputField("Data Fim", "forecast-data-fim", "date", true, "")}
                            <div class="flex space-x-2 lg:col-span-3">
                                <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Salvar</button>
                                <button type="button" id="btn-clear-forecast-form" class="w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Limpar</button>
                            </div>
                        </form>
                    </div>
                    <div class="overflow-x-auto bg-white rounded-xl shadow-2xl border border-gray-100">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100"><tr><th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Título</th><th class="p-4 text-center text-xs font-medium text-gray-500 uppercase">Ações</th></tr></thead>
                            <tbody id="forecast-table-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <h2 class="mt-12 text-3xl font-extrabold text-gray-900 border-b-4 border-red-500 pb-2 mb-4">Configurações do Sistema</h2>
                 <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl border border-red-200 space-y-4">
                     <h3 class="text-xl font-bold text-gray-800">Backup e Restauração</h3>
                     <p class="text-sm text-gray-600">Faça o backup de todos os dados ou restaure a partir de um arquivo.</p>
                     <div id="backup-message" class="hidden p-3 rounded-lg text-center font-medium"></div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <button id="btn-backup" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">${ICONS.DOWNLOAD} Fazer Backup</button>
                         <div><input type="file" id="restore-file-input" accept=".json" class="hidden"/><button onclick="document.getElementById('restore-file-input').click()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">${ICONS.UPLOAD} Restaurar</button></div>
                     </div>
                     <div id="restore-confirmation" class="hidden mt-4 p-4 bg-red-100 border-red-300 rounded-lg text-center"><p class="font-bold text-red-700">ATENÇÃO: A restauração substituirá TODOS os dados atuais. Ação irreversível.</p><button id="btn-confirm-restore" class="mt-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Confirmar</button></div>
                </div>
            `;
            
            renderPlannerTable();
            document.getElementById('planner-form').addEventListener('submit', handleSavePlannerTask);
            document.getElementById('btn-clear-planner-form').addEventListener('click', clearPlannerForm);
            document.getElementById('planner-table-body').addEventListener('click', handlePlannerTableActions);
            
            renderCaptacaoTable();
            document.getElementById('captacao-form').addEventListener('submit', handleSaveCaptacao);
            document.getElementById('btn-clear-captacao-form').addEventListener('click', clearCaptacaoForm);
            document.getElementById('captacao-table-body').addEventListener('click', handleCaptacaoTableActions);

            renderForecastTable();
            document.getElementById('forecast-form').addEventListener('submit', handleSaveForecast);
            document.getElementById('btn-clear-forecast-form').addEventListener('click', clearForecastForm);
            document.getElementById('forecast-table-body').addEventListener('click', handleForecastTableActions);

            document.getElementById('users-table-body').addEventListener('click', (e) => {
                if (e.target.classList.contains('update-user-btn')) handleUserUpdate(e.target.dataset.uid);
            });
            document.getElementById('btn-backup').addEventListener('click', handleBackup);
            document.getElementById('restore-file-input').addEventListener('change', (e) => {
                if(e.target.files.length > 0) document.getElementById('restore-confirmation').classList.remove('hidden');
            });
            document.getElementById('btn-confirm-restore').addEventListener('click', handleRestore);
        }

        function renderUserRow(user) {
            const isEditable = currentUser.role === ROLES.LIDER_FDV && user.id !== currentUser.uid;
            return `
                <tr class="hover:bg-blue-50">
                    <td class="p-4"><input type="text" value="${user.name || ''}" class="name-input bg-gray-50 border rounded p-1 w-full" data-uid="${user.id}" ${!isEditable ? 'disabled' : ''}></td>
                    <td class="p-4 text-sm text-gray-600">${user.email}</td>
                    <td class="p-4"><select class="role-selector bg-gray-50 border rounded p-1 w-full" data-uid="${user.id}" ${!isEditable ? 'disabled' : ''}>${Object.values(ROLES).map(role => `<option value="${role}" ${user.role === role ? 'selected' : ''}>${role}</option>`).join('')}</select></td>
                    <td class="p-4 text-center">${isEditable ? `<button class="update-user-btn bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600" data-uid="${user.id}">Salvar</button>` : ''}</td>
                </tr>`;
        }

        async function handleUserUpdate(uid) {
            const nameInput = document.querySelector(`.name-input[data-uid="${uid}"]`);
            const roleSelect = document.querySelector(`.role-selector[data-uid="${uid}"]`);
            const newName = nameInput.value.trim();
            if (!newName) { showToast('O nome não pode ficar em branco.', true); return; }
            try {
                await updateDoc(doc(db, USERS_COLLECTION_PATH, uid), { name: newName, role: roleSelect.value });
                showToast('Utilizador atualizado!', false);
            } catch (error) {
                showToast('Erro ao atualizar utilizador.', true);
            }
        }

        function renderPlannerTable() {
            const tableBody = document.getElementById('planner-table-body');
            if (!tableBody) return;
            const daysOrder = { "Segunda-feira": 1, "Terça-feira": 2, "Quarta-feira": 3, "Quinta-feira": 4, "Sexta-feira": 5, "Sábado": 6, "Domingo": 7 };
            const sortedPlannerData = [...plannerData].sort((a, b) => daysOrder[a.dayOfWeek] - daysOrder[b.dayOfWeek]);

            if (sortedPlannerData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">Nenhuma tarefa no planner.</td></tr>`;
                return;
            }
            tableBody.innerHTML = sortedPlannerData.map(task => `
                <tr data-task-id="${task.id}">
                    <td class="p-4 font-medium">${task.dayOfWeek}</td>
                    <td class="p-4">${task.atendenteName}</td>
                    <td class="p-4">${task.baseName}</td>
                    <td class="p-4 text-center space-x-2">
                        <button class="edit-planner-btn text-blue-600 hover:text-blue-800" data-task-id="${task.id}">Editar</button>
                        <button class="delete-planner-btn text-red-600 hover:text-red-800" data-task-id="${task.id}">Excluir</button>
                    </td>
                </tr>`).join('');
        }

        function clearPlannerForm() {
            document.getElementById('planner-form').reset();
            document.getElementById('planner-task-id').value = '';
            document.getElementById('planner-form-title').textContent = 'Adicionar Nova Tarefa';
        }

        function handlePlannerTableActions(e) {
            const taskId = e.target.dataset.taskId;
            if (!taskId) return;
            if (e.target.classList.contains('edit-planner-btn')) {
                const task = plannerData.find(t => t.id === taskId);
                if (task) {
                    document.getElementById('planner-task-id').value = task.id;
                    document.getElementById('planner-day').value = task.dayOfWeek;
                    document.getElementById('planner-atendente').value = task.atendenteId;
                    document.getElementById('planner-base-name').value = task.baseName;
                    document.getElementById('planner-base-link').value = task.baseLink || '';
                    document.getElementById('planner-form-title').textContent = 'Editar Tarefa';
                    document.getElementById('planner-management-section').scrollIntoView({ behavior: 'smooth' });
                }
            } else if (e.target.classList.contains('delete-planner-btn')) {
                showConfirm('Tem certeza que deseja excluir esta tarefa?', () => {
                    handleDeletePlannerTask(taskId);
                });
            }
        }

        async function handleSavePlannerTask(e) {
            e.preventDefault();
            const taskId = document.getElementById('planner-task-id').value;
            const dayOfWeek = document.getElementById('planner-day').value;
            const atendenteId = document.getElementById('planner-atendente').value;
            const baseName = document.getElementById('planner-base-name').value;
            const baseLink = document.getElementById('planner-base-link').value;
            if (!dayOfWeek || !atendenteId || !baseName) { showToast('Todos os campos são obrigatórios.', true); return; }
            const atendenteName = usersData.find(u => u.id === atendenteId)?.name || 'Desconhecido';
            const taskData = { dayOfWeek, atendenteId, atendenteName, baseName, baseLink };
            try {
                if (taskId) {
                    await updateDoc(doc(db, PLANNER_COLLECTION_PATH, taskId), taskData);
                    showToast('Tarefa atualizada!');
                } else {
                    await addDoc(collection(db, PLANNER_COLLECTION_PATH), taskData);
                    showToast('Tarefa adicionada!');
                }
                clearPlannerForm();
            } catch (error) { showToast('Erro ao salvar tarefa.', true); }
        }

        async function handleDeletePlannerTask(taskId) {
            try {
                await deleteDoc(doc(db, PLANNER_COLLECTION_PATH, taskId));
                showToast('Tarefa excluída!');
            } catch (error) { showToast('Erro ao excluir tarefa.', true); }
        }

        // --- Gerenciamento Bom Dia Captação ---
        function renderCaptacaoTable() {
            const tableBody = document.getElementById('captacao-table-body');
            if (!tableBody) return;
            const sortedData = [...bomDiaCaptacaoData].sort((a, b) => a.title.localeCompare(b.title));

            if (sortedData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="2" class="p-4 text-center text-gray-500">Nenhum dado cadastrado.</td></tr>`;
                return;
            }
            tableBody.innerHTML = sortedData.map(item => `
                <tr data-item-id="${item.id}">
                    <td class="p-4 font-medium">${item.title}</td>
                    <td class="p-4 text-center space-x-2">
                        <button class="edit-captacao-btn text-blue-600 hover:text-blue-800" data-item-id="${item.id}">Editar</button>
                        <button class="delete-captacao-btn text-red-600 hover:text-red-800" data-item-id="${item.id}">Excluir</button>
                    </td>
                </tr>`).join('');
        }

        function clearCaptacaoForm() {
            document.getElementById('captacao-form').reset();
            document.getElementById('captacao-id').value = '';
            document.getElementById('captacao-form-title').textContent = 'Adicionar/Editar Dados';
        }

        function handleCaptacaoTableActions(e) {
            const itemId = e.target.dataset.itemId;
            if (!itemId) return;

            if (e.target.classList.contains('edit-captacao-btn')) {
                const item = bomDiaCaptacaoData.find(d => d.id === itemId);
                if (item) {
                    document.getElementById('captacao-id').value = item.id;
                    document.getElementById('captacao-title').value = item.title;
                    ['meta-insc', 'meta-mat-fin', 'meta-mat-acad'].forEach(id => document.getElementById(id).value = item.metaDia[id.split('-')[1]]);
                    ['anterior-insc', 'anterior-mat-fin', 'anterior-mat-acad'].forEach(id => document.getElementById(id).value = item.anoAnterior[id.split('-')[1]]);
                    ['real-insc', 'real-mat-fin', 'real-mat-acad'].forEach(id => document.getElementById(id).value = item.real[id.split('-')[1]]);
                    document.getElementById('captacao-form-title').textContent = 'Editar Dados';
                    document.getElementById('bom-dia-captacao-management').scrollIntoView({ behavior: 'smooth' });
                }
            } else if (e.target.classList.contains('delete-captacao-btn')) {
                showConfirm('Tem certeza que deseja excluir este card de dados?', () => {
                    handleDeleteCaptacao(itemId);
                });
            }
        }

        async function handleSaveCaptacao(e) {
            e.preventDefault();
            const itemId = document.getElementById('captacao-id').value;
            const title = document.getElementById('captacao-title').value;

            const data = {
                title,
                metaDia: {
                    insc: Number(document.getElementById('meta-insc').value) || 0,
                    matFin: Number(document.getElementById('meta-mat-fin').value) || 0,
                    matAcad: Number(document.getElementById('meta-mat-acad').value) || 0,
                },
                anoAnterior: {
                    insc: Number(document.getElementById('anterior-insc').value) || 0,
                    matFin: Number(document.getElementById('anterior-mat-fin').value) || 0,
                    matAcad: Number(document.getElementById('anterior-mat-acad').value) || 0,
                },
                real: {
                    insc: Number(document.getElementById('real-insc').value) || 0,
                    matFin: Number(document.getElementById('real-mat-fin').value) || 0,
                    matAcad: Number(document.getElementById('real-mat-acad').value) || 0,
                },
                updatedAt: serverTimestamp(),
            };

            if (!data.title) {
                showToast("O título do card é obrigatório.", true);
                return;
            }

            try {
                if (itemId) {
                    await updateDoc(doc(db, BOM_DIA_CAPTACAO_COLLECTION_PATH, itemId), data);
                    showToast('Dados atualizados com sucesso!');
                } else {
                    await addDoc(collection(db, BOM_DIA_CAPTACAO_COLLECTION_PATH), data);
                    showToast('Dados adicionados com sucesso!');
                }
                clearCaptacaoForm();
            } catch (error) {
                console.error("Erro ao salvar dados de captação:", error);
                showToast('Erro ao salvar os dados.', true);
            }
        }

        async function handleDeleteCaptacao(itemId) {
            try {
                await deleteDoc(doc(db, BOM_DIA_CAPTACAO_COLLECTION_PATH, itemId));
                showToast('Dados excluídos com sucesso!');
            } catch (error) {
                console.error("Erro ao excluir dados de captação:", error);
                showToast('Erro ao excluir os dados.', true);
            }
        }

        // --- Gerenciamento Forecast Captação ---
        function renderForecastTable() {
            const tableBody = document.getElementById('forecast-table-body');
            if (!tableBody) return;
            const sortedData = [...forecastData].sort((a, b) => a.title.localeCompare(b.title));

            if (sortedData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="2" class="p-4 text-center text-gray-500">Nenhum dado cadastrado.</td></tr>`;
                return;
            }
            tableBody.innerHTML = sortedData.map(item => `
                <tr data-item-id="${item.id}">
                    <td class="p-4 font-medium">${item.title}</td>
                    <td class="p-4 text-center space-x-2">
                        <button class="edit-forecast-btn text-blue-600 hover:text-blue-800" data-item-id="${item.id}">Editar</button>
                        <button class="delete-forecast-btn text-red-600 hover:text-red-800" data-item-id="${item.id}">Excluir</button>
                    </td>
                </tr>`).join('');
        }
        
        function clearForecastForm() {
            document.getElementById('forecast-form').reset();
            document.getElementById('forecast-id').value = '';
            document.getElementById('forecast-form-title').textContent = 'Adicionar/Editar Dados do Forecast';
        }

        function handleForecastTableActions(e) {
            const itemId = e.target.dataset.itemId;
            if (!itemId) return;

            if (e.target.classList.contains('edit-forecast-btn')) {
                const item = forecastData.find(d => d.id === itemId);
                if (item) {
                    document.getElementById('forecast-id').value = item.id;
                    document.getElementById('forecast-title').value = item.title;
                    document.getElementById('forecast-ytd').value = item.ytd;
                    document.getElementById('forecast-real').value = item.real;
                    document.getElementById('forecast-meta').value = item.meta;
                    document.getElementById('forecast-projecao').value = item.projecao;
                    document.getElementById('forecast-data-inicio').value = item.dataInicio || '';
                    document.getElementById('forecast-data-fim').value = item.dataFim || '';
                    document.getElementById('forecast-form-title').textContent = 'Editar Dados do Forecast';
                    document.getElementById('forecast-management-section').scrollIntoView({ behavior: 'smooth' });
                }
            } else if (e.target.classList.contains('delete-forecast-btn')) {
                showConfirm('Tem certeza que deseja excluir este card de forecast?', () => {
                    handleDeleteForecast(itemId);
                });
            }
        }

        async function handleSaveForecast(e) {
            e.preventDefault();
            const itemId = document.getElementById('forecast-id').value;
            const data = {
                title: document.getElementById('forecast-title').value,
                ytd: Number(document.getElementById('forecast-ytd').value) || 0,
                real: Number(document.getElementById('forecast-real').value) || 0,
                meta: Number(document.getElementById('forecast-meta').value) || 0,
                projecao: Number(document.getElementById('forecast-projecao').value) || 0,
                dataInicio: document.getElementById('forecast-data-inicio').value,
                dataFim: document.getElementById('forecast-data-fim').value,
                updatedAt: serverTimestamp(),
            };

            if (!data.title || !data.dataInicio || !data.dataFim) {
                showToast("Título, Data Início e Data Fim são obrigatórios.", true);
                return;
            }

            try {
                if (itemId) {
                    await updateDoc(doc(db, FORECAST_CAPTACAO_COLLECTION_PATH, itemId), data);
                    showToast('Dados do forecast atualizados com sucesso!');
                } else {
                    await addDoc(collection(db, FORECAST_CAPTACAO_COLLECTION_PATH), data);
                    showToast('Dados do forecast adicionados com sucesso!');
                }
                clearForecastForm();
            } catch (error) {
                console.error("Erro ao salvar dados de forecast:", error);
                showToast('Erro ao salvar os dados do forecast.', true);
            }
        }

        async function handleDeleteForecast(itemId) {
            try {
                await deleteDoc(doc(db, FORECAST_CAPTACAO_COLLECTION_PATH, itemId));
                showToast('Dados de forecast excluídos com sucesso!');
            } catch (error) {
                console.error("Erro ao excluir dados de forecast:", error);
                showToast('Erro ao excluir os dados de forecast.', true);
            }
        }


        async function handleBackup() { /* Logic remains the same */ }
        async function handleRestore() { /* Logic remains the same */ }
        
        // --- Inicialização ---
        window.addEventListener('load', initApp);
    </script>
</body>
</html>

